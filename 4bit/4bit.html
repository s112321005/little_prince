<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è²“è²“æ˜Ÿçƒ - é‡å­è¶…ç«‹æ–¹é«”ç‰ˆ</title>
<style>
    /* ==================== å¤§åœ°è‰²ç³»è®Šæ•¸ ==================== */
    :root {
        --earth-brown: #8B7355;
        --earth-light: #D6CC98;
        --earth-dark: #5C4D3A;
        --earth-sand: #E8E1C6;
        --earth-clay: #B39C7D;
        --earth-tan: #C4B595;
        --earth-cream: #F5F1E0;
        --earth-coffee: #6F4E37;
    }

    /* ==================== ç™»å…¥é é¢æ¨£å¼ ==================== */
    #loginPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--earth-dark) 0%, var(--earth-brown) 50%, var(--earth-light) 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
    }
    
    .login-container {
        background: var(--earth-cream);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 400px;
        text-align: center;
        border: 3px solid var(--earth-coffee);
    }
    
    .login-title {
        color: var(--earth-coffee);
        margin-bottom: 30px;
        font-size: 2rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .login-input {
        width: 100%;
        padding: 12px 15px;
        margin: 10px 0;
        border: 2px solid var(--earth-tan);
        border-radius: 10px;
        font-size: 16px;
        background: white;
        color: var(--earth-dark);
        box-sizing: border-box;
    }
    
    .login-input:focus {
        outline: none;
        border-color: var(--earth-brown);
        box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.2);
    }
    
    .login-btn {
        width: 100%;
        padding: 14px;
        margin-top: 20px;
        background: var(--earth-brown);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .login-btn:hover {
        background: var(--earth-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .guest-btn {
        background: var(--earth-tan);
        color: var(--earth-dark);
        margin-top: 10px;
    }
    
    .guest-btn:hover {
        background: var(--earth-clay);
    }

    /* ==================== æ’è¡Œæ¦œæ¨£å¼ ==================== */
    #leaderboardBtn {
        position: fixed;
        top: 20px;
        right: 90px;
        width: 50px;
        height: 50px;
        background: rgba(139, 115, 85, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 22px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #leaderboardBtn:hover {
        background: var(--earth-dark);
        transform: scale(1.1);
    }
    
    #leaderboardBtn::before {
        content: "ğŸ†";
    }
    
    #leaderboardPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20000;
    }
    
    .leaderboard-container {
        background: var(--earth-cream);
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        border: 3px solid var(--earth-coffee);
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    
    .leaderboard-title {
        color: var(--earth-coffee);
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8rem;
        border-bottom: 2px solid var(--earth-tan);
        padding-bottom: 10px;
    }
    
    .leaderboard-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--earth-tan);
    }
    
    .leaderboard-tab {
        flex: 1;
        padding: 12px;
        background: var(--earth-sand);
        border: none;
        border-right: 1px solid var(--earth-tan);
        cursor: pointer;
        font-size: 16px;
        color: var(--earth-dark);
        transition: all 0.3s;
    }
    
    .leaderboard-tab:last-child {
        border-right: none;
    }
    
    .leaderboard-tab.active {
        background: var(--earth-brown);
        color: white;
        font-weight: bold;
    }
    
    .leaderboard-tab:hover:not(.active) {
        background: var(--earth-clay);
    }
    
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .leaderboard-table th {
        background: var(--earth-brown);
        color: white;
        padding: 12px;
        text-align: left;
        border-bottom: 3px solid var(--earth-coffee);
    }
    
    .leaderboard-table td {
        padding: 12px;
        border-bottom: 1px solid var(--earth-tan);
        color: var(--earth-dark);
    }
    
    .leaderboard-table tr:nth-child(even) {
        background: var(--earth-sand);
    }
    
    .leaderboard-table tr:hover {
        background: var(--earth-tan);
    }
    
    .leaderboard-rank {
        font-weight: bold;
        color: var(--earth-coffee);
        width: 50px;
        text-align: center;
    }
    
    .leaderboard-name {
        font-weight: bold;
    }
    
    .leaderboard-steps, .leaderboard-time {
        text-align: center;
        font-family: monospace;
    }
    
    .close-leaderboard {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--earth-dark);
        cursor: pointer;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .close-leaderboard:hover {
        background: var(--earth-tan);
    }
    
    .my-rank {
        background: rgba(214, 204, 152, 0.3) !important;
        font-weight: bold;
        border-left: 4px solid var(--earth-coffee);
    }
    
    /* ==================== ä¸»éŠæˆ²ä»‹é¢ ==================== */
    body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 20px;
        padding-bottom: 120px;
        min-width: 1100px;
        min-height: 100vh;
        background: var(--earth-light);
        font-family: sans-serif;
        overflow: auto;
        transition: all 0.4s ease;
    }

    #gameWrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 950px;
        position: relative;
        z-index: 50;
        margin: 0 auto;
    }
    
    #container {
        position: relative;
        width: 420px;
        height: 420px;
        overflow: visible;
        margin: 0 auto;
        transition: all 0.4s ease;
    }
    
    /* ç¾åŒ–ä¸‹æ‹‰é¸å–® */
    #bitSelector {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid var(--earth-tan);
        border-radius: 10px;
        background: white;
        font-size: 14px;
        color: var(--earth-dark);
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a654f' d='M6 8.5L1.5 4h9L6 8.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
    }
    
    #bitSelector:hover {
        border-color: var(--earth-brown);
        box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
    }
    
    #bitSelector:focus {
        outline: none;
        border-color: var(--earth-brown);
        box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
    }
    
    .planet {
        position: absolute;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,.2);
        transition: all 0.4s ease;
        z-index: 10;
        background: #fff;
    }
    
    .planet img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    /* 4bit ç¬¬äºŒå€‹ç«‹æ–¹é«”çš„ç‰¹æ®Šæ¨£å¼ï¼šåˆ·æ·¡ */
    .planet.faded {
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
    }
    
    .planet.faded img, .planet.faded .person {
        opacity: 1;
        filter: grayscale(40%) sepia(20%);
    }

    /* æ¨™ç±¤ */
    .planet[data-label]::after {
        content: attr(data-label);
        position: absolute;
        top: -25px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
        white-space: nowrap;
    }
    
    svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: auto;
        overflow: visible;
    }
    
    line {
        stroke: var(--earth-dark);
        stroke-width: 5;
        cursor: pointer;
        transition: stroke .3s;
    }
    
    line:hover {
        stroke: var(--earth-coffee);
    }
    
    /* 4bit é€£æ¥å…©å€‹ç«‹æ–¹é«”çš„ç·šæ¢æ¨£å¼ */
    line.hyper-line {
        stroke: var(--earth-clay);
        stroke-dasharray: 6, 6;
        opacity: 0.5;
        stroke-width: 3;
    }
    
    line.hyper-line:hover {
        stroke: var(--earth-coffee);
        opacity: 1;
        stroke-width: 6;
        stroke-dasharray: none;
    }

    .person {
        width: 90px;
        height: 90px;
        object-fit: contain;
        pointer-events: none;
        transition: transform .8s ease;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        transition: all 0.4s ease;
        z-index: 20;
    }
    
    .left-panel {
        position: absolute;
        left: 10px;
        top: 3vh;
        width: 220px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        font-size: 14px;
        color: var(--earth-dark);
        z-index: 100;
        max-height: 85vh;
        overflow-y: auto;
        transition: all 0.4s ease;
    }
    
    .left-panel h3 { 
        margin: 0 0 10px; 
        font-size: 15px; 
        text-align: center; 
        color: var(--earth-dark); 
    }
    
    #info { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 8px; 
        margin-bottom: 15px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid var(--earth-tan); 
    }
    
    #levelNumber { 
        font-size: 1.2rem; 
        font-weight: bold; 
        color: var(--earth-dark); 
    }
    
    #steps { 
        font-size: 1.1rem; 
        font-weight: bold; 
        color: var(--earth-dark); 
    }
    
    #timer { 
        font-size: 1rem; 
        color: var(--earth-dark); 
    }
    
    #buttons { 
        display: flex; 
        justify-content: center; 
        gap: 10px; 
        margin-top: 15px; 
        width: 100%; 
    }
    
    #resetBtn { 
        padding: 8px 16px; 
        background: var(--earth-brown); 
        color: #fff; 
        border: none; 
        border-radius: 8px; 
        font-size: 1rem; 
        cursor: pointer; 
    }
    
    #resetBtn:hover { 
        background: var(--earth-dark); 
    }
    
    #prevBtn, #nextBtn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: rgba(241, 241, 241, 0.7);
        color: var(--earth-brown);
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background .3s;
    }
    
    #prevBtn::after { 
        content: "â—€"; 
        position: relative; 
        top: -1px; 
        right: 3px; 
        font-size: 1.5rem; 
    }
    
    #nextBtn::after { 
        content: "â–¶"; 
        position: relative; 
        top: -1px; 
        left: 3px; 
        font-size: 1.5rem; 
    }
    
    #prevBtn:hover, #nextBtn:hover { 
        background-color: var(--earth-dark); 
        color: white; 
    }
    
    @media (max-width: 768px) {
        #container { width: 380px; height: 380px; }
        .planet { width: 120px; height: 120px; }
        .person { width: 80px; height: 80px; }
        body { padding-bottom: 200px; }
        .left-panel { top: auto; bottom: 20px; left: 20px; max-height: 40vh; }
    }
    
    .slide-out-left { animation: slideOutLeft .6s forwards; }
    .slide-in-right { animation: slideInRight .6s forwards; }
    .slide-out-right { animation: slideOutRight .6s forwards; }
    .slide-in-left { animation: slideInLeft .6s forwards; }
    
    @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .popup { 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,.4); 
        display: none; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
        animation: fadeIn .3s ease; 
    }
    
    .popup-content { 
        background: var(--earth-cream); 
        border-radius: 20px; 
        padding: 30px 40px; 
        text-align: center; 
        box-shadow: 0 5px 20px rgba(0,0,0,.3); 
        animation: popUp .4s ease; 
        max-width: 90%; 
        border: 3px solid var(--earth-coffee);
    }
    
    .popup-content h2 { 
        margin: 8px 0 10px; 
        color: var(--earth-coffee);
    }
    
    .popup-content p {
        color: var(--earth-dark);
    }
    
    .popup-content button { 
        background: var(--earth-brown); 
        color: #fff; 
        border: none; 
        border-radius: 12px; 
        padding: 10px 20px; 
        cursor: pointer; 
        font-size: 16px; 
        transition: background .2s; 
    }
    
    .popup-content button:hover { 
        background: var(--earth-dark); 
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popUp { from { transform: scale(.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .gate-section { 
        margin-top: 15px; 
        padding-top: 15px; 
        border-top: 1px solid var(--earth-tan); 
    }
    
    .gate-btns { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 6px; 
        margin-bottom: 10px; 
    }
    
    .gate-btn { 
        flex: 1 1 45%; 
        padding: 6px 8px; 
        background: white; 
        border: 1px solid var(--earth-tan); 
        border-radius: 10px; 
        font-size: 12px; 
        cursor: pointer; 
        box-shadow: 0 1px 3px rgba(0,0,0,.08); 
        text-align: center; 
        color: var(--earth-dark);
    }
    
    .gate-btn:hover { 
        background: var(--earth-sand); 
        box-shadow: 0 3px 8px rgba(0,0,0,.1); 
    }
    
    .gate-list { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 5px; 
        margin: 8px 0; 
        max-height: 80px; 
        overflow-y: auto; 
    }
    
    .gate-badge { 
        display: flex; 
        align-items: center; 
        gap: 5px; 
        padding: 3px 7px; 
        background: white; 
        border: 1px solid var(--earth-tan); 
        border-radius: 8px; 
        font-family: ui-monospace, monospace; 
        font-size: 11px; 
        box-shadow: 0 1px 2px rgba(0,0,0,.06); 
        color: var(--earth-dark);
    }
    
    .gate-badge .remove { 
        width: 15px; 
        height: 15px; 
        background: #ef4444; 
        color: #fff; 
        border: none; 
        border-radius: 50%; 
        font-size: 10px; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    
    .gate-badge .remove:hover { 
        background: #dc2626; 
    }
    
    .reset-circuit-btn { 
        width: 100%; 
        margin-top: 8px; 
        padding: 6px; 
        background: white; 
        border: 1px solid var(--earth-tan); 
        border-radius: 10px; 
        font-size: 12px; 
        cursor: pointer; 
        color: var(--earth-dark);
    }
    
    .reset-circuit-btn:hover { 
        background: var(--earth-sand); 
    }
    
    #undoBtn { 
        padding: 8px 16px; 
        background: var(--earth-brown); 
        color: #fff; 
        border: none; 
        border-radius: 8px; 
        font-size: 1rem; 
        cursor: pointer; 
        margin-top: 10px; 
        width: 100%; 
    }
    
    #undoBtn:hover { 
        background: var(--earth-dark); 
    }
    
    #undoBtn:disabled { 
        background: var(--earth-clay); 
        cursor: not-allowed; 
    }
    
    .circuit-panel { 
        position: fixed; 
        bottom: 10px; 
        left: 50%; 
        transform: translateX(-50%); 
        width: 80%; 
        max-width: 1000px; 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px); 
        border-radius: 16px; 
        padding: 14px; 
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); 
        font-size: 14px; 
        color: var(--earth-dark); 
        z-index: 100; 
        transition: all 0.4s ease; 
        border: 1px solid var(--earth-tan);
    }
    
    .circuit-panel h3 { 
        margin: 0 0 10px; 
        font-size: 15px; 
        color: var(--earth-dark); 
        text-align: center; 
    }
    
    .circuit-visualization { 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        margin-top: 10px; 
        position: relative; 
    }
    
    .circuit-line { 
        display: flex; 
        align-items: center; 
        height: 25px; 
        position: relative; 
        z-index: 10;
    }
    
    .circuit-line-label { 
        width: 30px; 
        text-align: center; 
        font-weight: bold; 
        font-size: 12px; 
        color: var(--earth-dark);
    }
    
    .circuit-line-path { 
        flex: 1; 
        height: 2px; 
        background: var(--earth-dark); 
        position: relative; 
        margin: 0 10px; 
    }
    
    .circuit-gate { 
        position: absolute; 
        top: 50%; 
        transform: translateY(-50%); 
        width: 18px; 
        height: 18px; 
        border-radius: 4px; 
        background: var(--earth-brown); 
        color: white; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 9px; 
        font-weight: bold; 
    }
    
    .circuit-control { 
        position: absolute; 
        top: 50%; 
        transform: translateY(-50%); 
        width: 10px; 
        height: 10px; 
        border-radius: 50%; 
        background: var(--earth-dark); 
        border: 2px solid var(--earth-dark); 
    }
    
    .circuit-control.hollow { 
        background: white !important; 
        border: 2px solid var(--earth-dark) !important; 
    }
    
    .circuit-target { 
        position: absolute; 
        top: 50%; 
        transform: translateY(-50%); 
        width: 18px; 
        height: 18px; 
        border-radius: 50%; 
        color: var(--earth-dark); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 20px; 
        font-weight: bold; 
    }
    
    .circuit-target::after { 
        content: "âŠ•"; 
    }
    
    .circuit-connector { 
        position: absolute; 
        left: 0; 
        top: 50%; 
        transform: translateY(-50%); 
        width: 2px; 
        height: 100%; 
        background: var(--earth-dark); 
        z-index: 1;
    }
    
    .hide-circuit-mode .left-panel, .hide-circuit-mode .circuit-panel { 
        transform: translateX(-120%) !important; 
        opacity: 0; 
        pointer-events: none; 
    }
    
    .hide-circuit-mode .circuit-panel { 
        transform: translateY(120%) !important; 
    }
    
    .toggle-circuit-btn { 
        position: fixed; 
        top: 20px; 
        right: 20px; 
        width: 50px; 
        height: 50px; 
        background: rgba(139, 115, 85, 0.9); 
        color: white; 
        border: none; 
        border-radius: 50%; 
        font-size: 24px; 
        cursor: pointer; 
        z-index: 10000; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        backdrop-filter: blur(8px); 
        transition: all 0.3s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    
    .toggle-circuit-btn:hover { 
        background: var(--earth-dark); 
        transform: scale(1.1); 
    }
    
    .toggle-circuit-btn::before { 
        content: "âš¡"; 
    }
    
    .hide-circuit-mode .toggle-circuit-btn::before { 
        content: "ğŸ‘ï¸"; 
    }
</style>
</head>
<body>
<!-- ç™»å…¥é é¢ -->
<div id="loginPage">
    <div class="login-container">
        <h1 class="login-title">ğŸ± è²“è²“æ˜Ÿçƒ ğŸŸ</h1>
        <p style="color: var(--earth-dark); margin-bottom: 25px;">æ­¡è¿ä¾†åˆ°é‡å­è²“è²“éŠæˆ²ï¼è«‹è¼¸å…¥æš±ç¨±é–‹å§‹éŠæˆ²</p>
        
        <input type="text" id="usernameInput" class="login-input" placeholder="è«‹è¼¸å…¥ä½ çš„æš±ç¨± (æœ€å¤š10å€‹å­—)" maxlength="10">
        
        <button id="startGameBtn" class="login-btn">é–‹å§‹éŠæˆ²</button>
        <button id="guestLoginBtn" class="login-btn guest-btn">ä»¥è¨ªå®¢èº«ä»½éŠç©</button>
    </div>
</div>

<!-- æ’è¡Œæ¦œæŒ‰éˆ• -->
<button id="leaderboardBtn" title="æŸ¥çœ‹æ’è¡Œæ¦œ (æˆ–æŒ‰ L éµ)"></button>

<!-- æ’è¡Œæ¦œé é¢ -->
<div id="leaderboardPage">
    <div class="leaderboard-container">
        <button class="close-leaderboard">Ã—</button>
        <h2 class="leaderboard-title">ğŸ† è²“è²“æ˜Ÿçƒæ’è¡Œæ¦œ ğŸ†</h2>
        
        <div class="leaderboard-tabs">
            <button class="leaderboard-tab active" data-bit="1">1 BIT</button>
            <button class="leaderboard-tab" data-bit="2">2 BIT</button>
            <button class="leaderboard-tab" data-bit="3">3 BIT</button>
            <button class="leaderboard-tab" data-bit="4">4 BIT</button>
        </div>
        
        <div id="leaderboardContent">
            <!-- æ’è¡Œæ¦œå…§å®¹æœƒç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- éŠæˆ²ä¸»ä»‹é¢ (åŸæœ¬çš„éŠæˆ²å…§å®¹) -->
<div id="gameWrapper">
  <h2 style="margin:10px 0 5px; color: var(--earth-coffee);">è²“è²“æ˜Ÿçƒ</h2>
  <div id="container"><svg></svg></div>
  <div id="buttons">
    <button id="prevBtn"></button>
    <button id="resetBtn">é‡æ–°é–‹å§‹</button>
    <button id="nextBtn"></button>
  </div>
</div>

<div class="left-panel">
  <h3>éŠæˆ²è³‡è¨Š</h3>
  <div id="info">
    <div id="levelNumber">é¡Œç›®ï¼š1</div>
    <div id="steps">æ­¥æ•¸ï¼š0</div>
    <div id="timer">æ™‚é–“ï¼š0 ç§’</div>
  </div>
  <div class="gate-section">
    <h3>é¸æ“‡ BIT æ•¸</h3>
    <select id="bitSelector">
      <option value="1">1 BIT</option>
      <option value="2" selected>2 BIT</option>
      <option value="3">3 BIT</option>
      <option value="4">4 BIT</option>
    </select>
    <h3 style="margin-top:10px;">æ–°å¢é‡å­é–˜é–€</h3>
    <div class="gate-btns">
      </div>
    <h3 style="margin-top:10px;">ç›®å‰é›»è·¯</h3>
    <div id="gateList" class="gate-list"></div>
    <button class="reset-circuit-btn" onclick="resetCircuit()">é‡è¨­é›»è·¯</button>
    <button id="undoBtn" onclick="undoLastStep()" disabled>å›åˆ°ä¸Šä¸€æ­¥</button>
  </div>
</div>

<div class="circuit-panel">
  <h3>é›»è·¯åœ–</h3>
  <div id="circuitVisualization" class="circuit-visualization"></div>
</div>

<div id="successPopup" class="popup">
  <div class="popup-content">
    <h2>æ­å–œä½ æˆåŠŸäº†ï¼</h2>
    <p id="successMessage"></p><br>
    <button id="closePopup">å†ç©ä¸€æ¬¡</button>
  </div>
</div>

<button class="toggle-circuit-btn" id="toggleCircuitBtn" title="åˆ‡æ›éš±è—é›»è·¯æ¨¡å¼ï¼ˆæˆ–æŒ‰ H éµï¼‰"></button>

<script>
/* ==================== ç©å®¶è³‡æ–™èˆ‡æ’è¡Œæ¦œç³»çµ± ==================== */
let currentPlayer = {
    name: "è¨ªå®¢",
    isGuest: true,
    scores: {
        1: [], // 1 BIT é—œå¡ç´€éŒ„
        2: [], // 2 BIT é—œå¡ç´€éŒ„
        3: [], // 3 BIT é—œå¡ç´€éŒ„
        4: []  // 4 BIT é—œå¡ç´€éŒ„
    }
};

// åˆå§‹åŒ–æ’è¡Œæ¦œè³‡æ–™ (å¦‚æœæœ¬åœ°å„²å­˜æœ‰è³‡æ–™å‰‡è¼‰å…¥)
let leaderboardData = {
    1: JSON.parse(localStorage.getItem('catPlanetLeaderboard_1')) || [],
    2: JSON.parse(localStorage.getItem('catPlanetLeaderboard_2')) || [],
    3: JSON.parse(localStorage.getItem('catPlanetLeaderboard_3')) || [],
    4: JSON.parse(localStorage.getItem('catPlanetLeaderboard_4')) || []
};

/* ==================== ç™»å…¥ç³»çµ± ==================== */
document.getElementById('startGameBtn').addEventListener('click', function() {
    const username = document.getElementById('usernameInput').value.trim();
    
    if (username === '') {
        alert('è«‹è¼¸å…¥æš±ç¨±ï¼');
        return;
    }
    
    if (username.length > 10) {
        alert('æš±ç¨±ä¸èƒ½è¶…é10å€‹å­—ï¼');
        return;
    }
    
    currentPlayer.name = username;
    currentPlayer.isGuest = false;
    
    // æ·¡å‡ºç™»å…¥é é¢
    document.getElementById('loginPage').style.opacity = '0';
    
    setTimeout(() => {
        document.getElementById('loginPage').style.display = 'none';
        // è¼‰å…¥ç©å®¶è³‡æ–™
        loadPlayerData();
    }, 500);
});

document.getElementById('guestLoginBtn').addEventListener('click', function() {
    currentPlayer.name = "è¨ªå®¢" + Math.floor(Math.random() * 10000);
    currentPlayer.isGuest = true;
    
    // æ·¡å‡ºç™»å…¥é é¢
    document.getElementById('loginPage').style.opacity = '0';
    
    setTimeout(() => {
        document.getElementById('loginPage').style.display = 'none';
    }, 500);
});

/* ==================== æ’è¡Œæ¦œç³»çµ± ==================== */
function showLeaderboard() {
    document.getElementById('leaderboardPage').style.display = 'flex';
    updateLeaderboardDisplay(bitCount); // é è¨­é¡¯ç¤ºç•¶å‰ BIT æ•¸çš„æ’è¡Œæ¦œ
}

function closeLeaderboard() {
    document.getElementById('leaderboardPage').style.display = 'none';
}

function updateLeaderboardDisplay(bit) {
    const content = document.getElementById('leaderboardContent');
    const data = leaderboardData[bit] || [];
    
    // æ’åºè³‡æ–™ (æ­¥æ•¸å„ªå…ˆï¼Œæ™‚é–“ç¬¬äºŒ)
    const sortedData = [...data].sort((a, b) => {
        if (a.steps !== b.steps) return a.steps - b.steps;
        return a.time - b.time;
    });
    
    // ç”Ÿæˆè¡¨æ ¼
    let html = `<table class="leaderboard-table">
        <thead>
            <tr>
                <th class="leaderboard-rank">æ’å</th>
                <th class="leaderboard-name">ç©å®¶</th>
                <th class="leaderboard-steps">æ­¥æ•¸</th>
                <th class="leaderboard-time">æ™‚é–“(ç§’)</th>
                <th>é—œå¡</th>
            </tr>
        </thead>
        <tbody>`;
    
    if (sortedData.length === 0) {
        html += `<tr><td colspan="5" style="text-align:center; padding:30px;">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æˆç‚ºç¬¬ä¸€ä½ï¼</td></tr>`;
    } else {
        sortedData.slice(0, 20).forEach((record, index) => {
            const isCurrentPlayer = !currentPlayer.isGuest && record.player === currentPlayer.name;
            const rowClass = isCurrentPlayer ? 'my-rank' : '';
            
            html += `<tr class="${rowClass}">
                <td class="leaderboard-rank">${index + 1}</td>
                <td class="leaderboard-name">${record.player}</td>
                <td class="leaderboard-steps">${record.steps}</td>
                <td class="leaderboard-time">${record.time}</td>
                <td>${record.level}</td>
            </tr>`;
        });
    }
    
    html += `</tbody></table>`;
    content.innerHTML = html;
}

// æ–°å¢åˆ†æ•¸åˆ°æ’è¡Œæ¦œ
function addScoreToLeaderboard(steps, time, level, bit) {
    if (currentPlayer.isGuest) return; // è¨ªå®¢ä¸ç´€éŒ„åˆ†æ•¸
    
    const score = {
        player: currentPlayer.name,
        steps: steps,
        time: time,
        level: level + 1, // é—œå¡ç·¨è™Ÿå¾1é–‹å§‹
        date: new Date().toISOString().split('T')[0]
    };
    
    // æ·»åŠ åˆ°å°æ‡‰ BIT æ•¸çš„æ’è¡Œæ¦œ
    leaderboardData[bit].push(score);
    
    // é™åˆ¶æ¯ BIT æ•¸æœ€å¤šä¿å­˜100ç­†ç´€éŒ„
    if (leaderboardData[bit].length > 100) {
        leaderboardData[bit] = leaderboardData[bit].slice(-100);
    }
    
    // å„²å­˜åˆ°æœ¬åœ°å„²å­˜
    localStorage.setItem(`catPlanetLeaderboard_${bit}`, JSON.stringify(leaderboardData[bit]));
    
    // æ›´æ–°ç©å®¶å€‹äººæœ€ä½³ç´€éŒ„
    updatePlayerBestScore(score, bit);
}

// æ›´æ–°ç©å®¶å€‹äººæœ€ä½³ç´€éŒ„
function updatePlayerBestScore(score, bit) {
    const playerScores = currentPlayer.scores[bit];
    const existingScore = playerScores.find(s => s.level === score.level);
    
    if (!existingScore) {
        playerScores.push(score);
    } else if (score.steps < existingScore.steps || 
              (score.steps === existingScore.steps && score.time < existingScore.time)) {
        // æ›´æ–°ç‚ºæ›´å¥½çš„ç´€éŒ„
        Object.assign(existingScore, score);
    }
    
    // å„²å­˜ç©å®¶è³‡æ–™
    savePlayerData();
}

// è¼‰å…¥ç©å®¶è³‡æ–™
function loadPlayerData() {
    if (currentPlayer.isGuest) return;
    
    const savedData = localStorage.getItem(`catPlanetPlayer_${currentPlayer.name}`);
    if (savedData) {
        const playerData = JSON.parse(savedData);
        currentPlayer.scores = playerData.scores || currentPlayer.scores;
    }
}

// å„²å­˜ç©å®¶è³‡æ–™
function savePlayerData() {
    if (currentPlayer.isGuest) return;
    
    localStorage.setItem(`catPlanetPlayer_${currentPlayer.name}`, JSON.stringify(currentPlayer));
}

/* ==================== æ’è¡Œæ¦œäº‹ä»¶ç›£è½ ==================== */
document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);

document.querySelector('.close-leaderboard').addEventListener('click', closeLeaderboard);

document.querySelectorAll('.leaderboard-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active é¡
        document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
        
        // æ·»åŠ ç•¶å‰æ¨™ç±¤çš„ active é¡
        this.classList.add('active');
        
        // æ›´æ–°é¡¯ç¤ºçš„æ’è¡Œæ¦œ
        const bit = parseInt(this.dataset.bit);
        updateLeaderboardDisplay(bit);
    });
});

// éµç›¤å¿«æ·éµ
document.addEventListener('keydown', function(e) {
    if (e.key.toLowerCase() === 'l') {
        showLeaderboard();
    }
});

// é»æ“Šæ’è¡Œæ¦œå¤–éƒ¨é—œé–‰
document.getElementById('leaderboardPage').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLeaderboard();
    }
});

/* ==================== åŸå§‹ 1/2 bit åœ–ç‰‡èˆ‡è³‡æ–™ ==================== */
const raw = "https://raw.githubusercontent.com/s112321005/little_prince/main/";
const planetImg = {
  "3flower": raw+"3flower_00.png",
  "Bob":     raw+"Bob_01.png",
  "Kurover": raw+"Kurover_10.png",
  "doll":    raw+"doll_11.png"
};
const fishImg = {
  "3flowerFish": raw+"3flowerFish.png",
  "BobFish":     raw+"BobFish.png",
  "KuroFish":    raw+"KuroFish.png",
  "dollFish":    raw+"dollFish%20.png"
};
 
/* ==================== 3 bit åœ–ç‰‡èˆ‡è³‡æ–™ ==================== */
const raw3 = "https://raw.githubusercontent.com/s112321005/little_prince/main/3bit/";
const baseNames = ["3flower", "Bob", "Kurover", "Siam", "Black", "Bins", "Sakaban", "White"];
const planetImg3 = {
  "3flower": raw3+"3flower_000.png",
  "Bob":     raw3+"Bob_001.png",
  "Kurover": raw3+"Kurover_010.png",
  "Siam":    raw3+"Siam_011.png",
  "Black":   raw3+"Black_100.png",
  "Bins":    raw3+"Bins_101.png",
  "Sakaban": raw3+"Sakaban_110.png",
  "White":   raw3+"White_111.png"
};
const fishImg3 = {
  "3flowerFish": raw3+"3flowerFish.png",
  "BobFish":     raw3+"BobFish.png",
  "KuroverFish": raw3+"KuroFish.png",
  "SiamFish":    raw3+"SiamFish.png",
  "BlackFish":   raw3+"BlackFish.png",
  "BinsFish":    raw3+"BinsFish.png",
  "SakabanFish": raw3+"SakabanFish.png",
  "WhiteFish":   raw3+"WhiteFish.png"
};

/* ==================== 4 bit åœ–ç‰‡èˆ‡è³‡æ–™ ==================== */
const raw4 = "https://s112321005.github.io/little_prince/4bit%20cat/";

/* ==================== åŸå§‹ 24 å€‹ 2bit æ’åˆ— ==================== */
const permList = [
  "0132","0213","0231","0312","0321",
  "1023","1032","1203","1230","1302","1320",
  "2013","2031","2103","2130","2301","2310",
  "3012","3021","3102","3120","3201","3210"
].map(s => s.split("").map(Number));
 
/* ==================== 3bit / 4bit éš¨æ©Ÿæ’åˆ— ==================== */
function genPerm(n) {
  let a = Array.from({length: n}, (_, i) => i);
  for (let i=n-1; i>0; i--) {
    let j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
const permList3bit = Array.from({length: 30}, () => genPerm(8));
permList3bit.push([7, 6, 5, 4, 3, 2, 1, 0]);

// 4bit æ’åˆ—ï¼šç‰¹åˆ¥è¨­è¨ˆ
const permList4bit = [];
// ç¬¬ 1 é—œï¼šå¼·åˆ¶å®Œå…¨äº¤æ› (Cross Swap) - å·¦é‚Šæ˜Ÿçƒå…¨æ˜¯å³é‚Šçš„é­šï¼Œå³é‚Šæ˜Ÿçƒå…¨æ˜¯å·¦é‚Šçš„é­š
permList4bit.push(Array.from({length: 16}, (_, i) => (i + 8) % 16));
// ç¬¬ 2 é—œï¼šéš¨æ©Ÿ
permList4bit.push(genPerm(16));
// ç¬¬ 3 é—œï¼šå®Œå…¨åè½‰
permList4bit.push(Array.from({length: 16}, (_, i) => 15-i));
// å¾ŒçºŒéš¨æ©Ÿè£œæ»¿
for(let k=0; k<10; k++) permList4bit.push(genPerm(16));

/* ==================== é—œå¡è³‡æ–™ ==================== */
let bitCount = 2;

function generate4BitLevelData() {
    // é›–ç„¶ 4bit ä½¿ç”¨æ–°çš„åœ–ç‰‡ï¼Œä½†åº§æ¨™ä»å€Ÿç”¨ basePos çš„çµæ§‹
    const basePos = [
        {top:140, left:140}, // 000
        {top:140, left:340}, // 001
        {top:340, left:140}, // 010
        {top:340, left:340}, // 011
        {top:20,  left:20},  // 100
        {top:20,  left:460}, // 101
        {top:460, left:20},  // 110
        {top:460, left:460}  // 111
    ];

    const planets = [];
    const scale = 1.7;

    // Cube 1 (å·¦é‚Š)
    const offX1 = 0;
    const offY1 = 180;

    // Cube 2 (å³é‚Š)
    const offX2 = 500;
    const offY2 = 20;

    for(let i=0; i<8; i++) {
        // ç”Ÿæˆ key 0000 ~ 0111
        let keyStr = i.toString(2).padStart(4, "0");
        planets.push({
            id: `planet${i}`,
            key: keyStr,
            label: keyStr,
            top: basePos[i].top/scale + offY1,
            left: basePos[i].left/scale + offX1,
            isFaded: false
        });
    }
    for(let i=0; i<8; i++) {
        // ç”Ÿæˆ key 1000 ~ 1111
        let keyStr = (i+8).toString(2).padStart(4, "0");
        planets.push({
            id: `planet${i+8}`,
            key: keyStr,
            label: keyStr,
            top: basePos[i].top/scale + offY2,
            left: basePos[i].left/scale + offX2,
            isFaded: true
        });
    }

    const lines = [];
    const baseConnections = [
        [0,1],[0,2],[1,3],[2,3],
        [4,5],[4,6],[5,7],[6,7],
        [0,4],[1,5],[2,6],[3,7]  
    ];
    baseConnections.forEach(([a,b]) => {
        lines.push([`l${a}_${b}`, `planet${a}`, `planet${b}`]);
        lines.push([`l${a+8}_${b+8}`, `planet${a+8}`, `planet${b+8}`]);
    });

    for(let i=0; i<8; i++) {
        lines.push([`hyper${i}`, `planet${i}`, `planet${i+8}`, true]);
    }

    return (permIndex) => {
        const perm = permList4bit[permIndex] || permList4bit[0];
        const princes = [];
       
        for(let i=0; i<16; i++) {
            // 4bit é­šçš„åœ–ç‰‡ç›´æ¥ä½¿ç”¨äºŒé€²ä½ç·¨ç¢¼åç¨±
            const fishKeyStr = i.toString(2).padStart(4, "0");
            princes.push({
                img: raw4 + fishKeyStr + "Fish.png",
                target: `planet${i}`,
                // é€™è£¡æ¨™è¨˜ target >= 8 çš„é­šå°±æ˜¯"è™›æ“¬é­š"ï¼ŒéŠæˆ²å‹åˆ©åˆ¤å®šæ™‚æœƒç”¨åˆ°
                isFadedFish: i >= 8
            });
        }
        return { planets, lines, princes };
    };
}

const get4BitLevel = generate4BitLevelData();

const bitLevels = {
  1: [{
    planets: [{id:"planet1", key:"3flower", top:140, left:20}, {id:"planet2", key:"Bob", top:140, left:260}],
    princes: [{img: fishImg["3flowerFish"], target:"planet1"}, {img: fishImg["BobFish"], target:"planet2"}],
    lines:[["line12","planet1","planet2"]]
  }],
  2: Array.from({length: permList.length}, () => ({
    planets: [
      {id:"planet1", key:"3flower", top:0,    left:0},
      {id:"planet2", key:"Bob",     top:0,    left:280},
      {id:"planet3", key:"Kurover", top:280, left:0},
      {id:"planet4", key:"doll",    top:280, left:280}
    ],
    princes: [
      {img: fishImg["3flowerFish"], target:"planet1"},
      {img: fishImg["BobFish"],     target:"planet2"},
      {img: fishImg["KuroFish"],    target:"planet3"},
      {img: fishImg["dollFish"],    target:"planet4"}
    ],
    lines: [["line12","planet1","planet2"],["line13","planet1","planet3"],["line24","planet2","planet4"],["line34","planet3","planet4"]]
  })),
  3: permList3bit.map(() => ({
    planets: [
      {id:"planet0", key:"3flower", label:"000", top:140, left:140},
      {id:"planet1", key:"Bob",     label:"001", top:140, left:340},
      {id:"planet2", key:"Kurover", label:"010", top:340, left:140},
      {id:"planet3", key:"Siam",    label:"011", top:340, left:340},
      {id:"planet4", key:"Black",   label:"100", top:20,  left:20},
      {id:"planet5", key:"Bins",    label:"101", top:20,  left:460},
      {id:"planet6", key:"Sakaban", label:"110", top:460, left:20},
      {id:"planet7", key:"White",   label:"111", top:460, left:460}
    ],
    princes: [
      {img: fishImg3["3flowerFish"], target:"planet0"},
      {img: fishImg3["BobFish"],     target:"planet1"},
      {img: fishImg3["KuroverFish"], target:"planet2"},
      {img: fishImg3["SiamFish"],    target:"planet3"},
      {img: fishImg3["BlackFish"],   target:"planet4"},
      {img: fishImg3["BinsFish"],    target:"planet5"},
      {img: fishImg3["SakabanFish"], target:"planet6"},
      {img: fishImg3["WhiteFish"],   target:"planet7"}
    ],
    lines: [
      ["l01","planet0","planet1"],["l02","planet0","planet2"],["l13","planet1","planet3"],["l23","planet2","planet3"],
      ["l45","planet4","planet5"],["l46","planet4","planet6"],["l57","planet5","planet7"],["l67","planet6","planet7"],
      ["l04","planet0","planet4"],["l15","planet1","planet5"],["l26","planet2","planet6"],["l37","planet3","planet7"]
    ]
  })),
  4: permList4bit.map((_, idx) => get4BitLevel(idx))
};
 
/* ==================== æ ¸å¿ƒè®Šæ•¸ ==================== */
let currentLevel = 0, steps = 0, startTime, timerInterval;
let circuit = [], currentMap = [];
let planets = {}, princes = [];
let history = [];
const stepDisplay = document.getElementById("steps");
const timerDisplay = document.getElementById("timer");
const container = document.getElementById("container");
const svg = container.querySelector("svg");
const undoBtn = document.getElementById("undoBtn");

/* ==================== å·¥å…·å‡½æ•¸ ==================== */
function stateIndexToBits(i) { 
    // ä¿®æ­£ï¼š2bit æ¨¡å¼æ™‚ï¼Œéœ€è¦æ­£ç¢ºè™•ç†ç´¢å¼•è½‰æ›
    if (bitCount === 2) {
        // 2bit çš„è¡Œæ˜Ÿç·¨è™Ÿæ˜¯ 1-4ï¼Œä½†ç‹€æ…‹æ˜¯ 00(0), 01(1), 10(2), 11(3)
        // æ‰€ä»¥ç•¶ç´¢å¼•æ˜¯ 0-3 æ™‚ï¼Œè½‰æ›æˆå°æ‡‰çš„ä½å…ƒ
        return i.toString(2).padStart(bitCount,"0").split("").map(Number); 
    }
    return i.toString(2).padStart(bitCount,"0").split("").map(Number); 
}

function bitsToStateIndex(bits) { 
    return parseInt(bits.join(""),2); 
}

function applyGateToIndex(stateIndex, gate){
  const b = stateIndexToBits(stateIndex);
  const nb = b.slice();
  const getBitIndex = (t) => t;

  switch(gate.type){
    case "X":
      nb[getBitIndex(gate.target)] ^= 1;
      break;
    case "CNOT":
      if(nb[getBitIndex(gate.control)]) nb[getBitIndex(gate.target)] ^= 1;
      break;
    case "0CNOT":
      if(nb[getBitIndex(gate.control)]===0) nb[getBitIndex(gate.target)] ^= 1;
      break;
    case "CCNOT":
      const c1Val = nb[getBitIndex(gate.control1)];
      const c2Val = nb[getBitIndex(gate.control2)];
      const c1Ok = (gate.c1Val === 1) ? (c1Val === 1) : (c1Val === 0);
      const c2Ok = (gate.c2Val === 1) ? (c2Val === 1) : (c2Val === 0);
      if(c1Ok && c2Ok) {
        nb[getBitIndex(gate.target)] ^= 1;
      }
      break;
    case "MCNOT":
      let trigger = true;
      for(let c of gate.controls) {
          const currentBitVal = nb[getBitIndex(c.bit)];
          if(currentBitVal !== c.val) {
              trigger = false;
              break;
          }
      }
      if(trigger) {
          nb[getBitIndex(gate.target)] ^= 1;
      }
      break;
  }
  return bitsToStateIndex(nb);
}

function renderGateButtons(){
  const box = document.querySelector(".gate-btns");
  box.innerHTML = "";

  let gates = [];

  if (bitCount === 4) {
      // 4 Bit
      [0,1,2,3].forEach(i => {
          gates.push({text:`X q${i}`, g:{type:"X", target:i}});
      });
      gates.push({text:"CNOT q0â†’q1", g:{type:"CNOT", control:0, target:1}});
      gates.push({text:"CNOT q3â†’q2", g:{type:"CNOT", control:3, target:2}});
  } else if (bitCount === 3) {
      // å®Œæ•´çš„ 3-bit é–˜é–€è¨­å®š
      // 3å€‹ å–®é‡å­æ¯”ç‰¹ X
      gates.push({text:"X q0", g:{type:"X",target:0}});
      gates.push({text:"X q1", g:{type:"X",target:1}});
      gates.push({text:"X q2", g:{type:"X",target:2}});

      // 12 å€‹ Toffoli Gates (ä¾ç›®æ¨™ä½å…ƒåˆ†çµ„)
      // Target: q2 (Controls: q0, q1)
      gates.push({text:"TOF(q0,q1,   q2)", g:{type:"CCNOT", control1:0, c1Val:1, control2:1, c2Val:1, target:2}});
      gates.push({text:"TOF(q0',q1', q2)", g:{type:"CCNOT", control1:0, c1Val:0, control2:1, c2Val:0, target:2}});
      gates.push({text:"TOF(q0',q1,  q2)", g:{type:"CCNOT", control1:0, c1Val:0, control2:1, c2Val:1, target:2}});
      gates.push({text:"TOF(q0,q1',  q2)", g:{type:"CCNOT", control1:0, c1Val:1, control2:1, c2Val:0, target:2}});

      // Target: q1 (Controls: q0, q2)
      gates.push({text:"TOF(q0,q2,   q1)", g:{type:"CCNOT", control1:0, c1Val:1, control2:2, c2Val:1, target:1}});
      gates.push({text:"TOF(q0',q2', q1)", g:{type:"CCNOT", control1:0, c1Val:0, control2:2, c2Val:0, target:1}});
      gates.push({text:"TOF(q0',q2,  q1)", g:{type:"CCNOT", control1:0, c1Val:0, control2:2, c2Val:1, target:1}});
      gates.push({text:"TOF(q0,q2',  q1)", g:{type:"CCNOT", control1:0, c1Val:1, control2:2, c2Val:0, target:1}});

      // Target: q0 (Controls: q1, q2)
      gates.push({text:"TOF(q1,q2,   q0)", g:{type:"CCNOT", control1:1, c1Val:1, control2:2, c2Val:1, target:0}});
      gates.push({text:"TOF(q1',q2', q0)", g:{type:"CCNOT", control1:1, c1Val:0, control2:2, c2Val:0, target:0}});
      gates.push({text:"TOF(q1',q2,  q0)", g:{type:"CCNOT", control1:1, c1Val:0, control2:2, c2Val:1, target:0}});
      gates.push({text:"TOF(q1,q2',  q0)", g:{type:"CCNOT", control1:1, c1Val:1, control2:2, c2Val:0, target:0}});

      // 6 å€‹æ™®é€š CNOT (1-Control)
      gates.push({text:"CNOT q0â†’q1", g:{type:"CNOT",control:0,target:1}});
      gates.push({text:"CNOT q1â†’q0", g:{type:"CNOT",control:1,target:0}});
      gates.push({text:"CNOT q0â†’q2", g:{type:"CNOT",control:0,target:2}});
      gates.push({text:"CNOT q2â†’q0", g:{type:"CNOT",control:2,target:0}});
      gates.push({text:"CNOT q1â†’q2", g:{type:"CNOT",control:1,target:2}});
      gates.push({text:"CNOT q2â†’q1", g:{type:"CNOT",control:2,target:1}});

      // 6 å€‹ 0-Control CNOT
      gates.push({text:"0CNOT q0â†’q1", g:{type:"0CNOT",control:0,target:1}});
      gates.push({text:"0CNOT q1â†’q0", g:{type:"0CNOT",control:1,target:0}});
      gates.push({text:"0CNOT q0â†’q2", g:{type:"0CNOT",control:0,target:2}});
      gates.push({text:"0CNOT q2â†’q0", g:{type:"0CNOT",control:2,target:0}});
      gates.push({text:"0CNOT q1â†’q2", g:{type:"0CNOT",control:1,target:2}});
      gates.push({text:"0CNOT q2â†’q1", g:{type:"0CNOT",control:2,target:1}});
  } else if (bitCount === 2) {
      // ä¿®æ­£ï¼š2bit çš„å®Œæ•´é–˜é–€è¨­å®š
      gates.push({text:"X q0", g:{type:"X",target:0}});
      gates.push({text:"X q1", g:{type:"X",target:1}});
      gates.push({text:"1CNOT q0â†’q1", g:{type:"CNOT",control:0,target:1}});
      gates.push({text:"0CNOT q0â†’q1", g:{type:"0CNOT",control:0,target:1}});
      gates.push({text:"1CNOT q1â†’q0", g:{type:"CNOT",control:1,target:0}});
      gates.push({text:"0CNOT q1â†’q0", g:{type:"0CNOT",control:1,target:0}});
  } else {
      // 1-bit é–˜é–€
      gates.push({text:"X q0", g:{type:"X",target:0}});
  }

  gates.forEach(o=>{
    const b = document.createElement("button");
    b.className="gate-btn";
    b.textContent = o.text;
    b.onclick = ()=>applyGateAndAnimate(o.g);
    box.appendChild(b);
  });
}

/* ==================== å…¶é¤˜å‡½æ•¸ ==================== */
function addGateToList(g){ circuit.push(g); renderGateList(); renderCircuitVisualization(); }
function resetCircuit(){
  saveStateToHistory();
  circuit = [];
  currentMap = Array.from({length: 1<<bitCount}, (_,i)=>i);
  renderGateList();
  renderCircuitVisualization();
  softResetFish();
  updateUndoButton();
}
function renderGateList(){
  const box = document.getElementById("gateList"); box.innerHTML = "";
  circuit.forEach((g,idx)=>{
    const el = document.createElement("div"); el.className = "gate-badge";
    let label = "";
    if(g.type==="X") label = `X q${g.target}`;
    else if(g.type==="CNOT") label = `C${g.control}X${g.target}`;
    else if(g.type==="0CNOT") label = `0C${g.control}X${g.target}`;
    else if(g.type==="CCNOT") {
      label = `C${g.control1}(${g.c1Val})C${g.control2}(${g.c2Val})X${g.target}`;
    } else if(g.type==="MCNOT") {
        const ctrls = g.controls.map(c => `q${c.bit}(${c.val})`).join(",");
        label = `M(${ctrls})â†’X${g.target}`;
    }
    el.innerHTML = `<span>${label}</span>`;
    const x = document.createElement("button"); x.className="remove"; x.textContent="x";
    x.onclick = ()=>{ saveStateToHistory(); circuit.splice(idx,1); renderGateList(); renderCircuitVisualization(); updateUndoButton(); };
    el.appendChild(x); box.appendChild(el);
  });
}
function saveStateToHistory() {
  // ä¿å­˜é­šçš„ HTML çµæ§‹ (åŒ…å« class) æ¯”è¼ƒä¿éšªï¼Œæˆ–è€…ä¿å­˜ src å’Œ opacity ç‹€æ…‹
  // é€™è£¡æˆ‘å€‘é‡æ–°æŠ“å–é­šçš„è³‡æ–™
  const fishData = {};
  Object.keys(planets).forEach(id=>{
      const f = planets[id].querySelector(".person");
      if(f) {
          fishData[id] = { src: f.src, isGhost: f.classList.contains("ghost-fish") };
      }
  });

  const state = { circuit: JSON.parse(JSON.stringify(circuit)), currentMap: [...currentMap], fish: fishData };
  history.push(state);
  if(history.length > 50) history.shift();
  updateUndoButton();
}
// æ¢å¾©æ­·å²ç´€éŒ„
function restoreFishPositions(fishData){
  Object.values(planets).forEach(p=>p.querySelectorAll(".person").forEach(img=>img.remove()));
  Object.entries(fishData).forEach(([id, data])=>{
    if(planets[id]){
      const img = document.createElement("img");
      img.src = data.src;
      img.className = "person";
      if(data.isGhost) img.classList.add("ghost-fish");
     
      // å¾©åŸ CSS æ¨£å¼
      if(data.isGhost) {
         img.style.opacity = "1"; // ä¿®æ”¹ï¼šæ”¹å› 1
         img.style.filter = "grayscale(40%) sepia(20%)";
      } else {
         img.style.opacity = "1";
         img.style.filter = "none";
      }
     
      planets[id].appendChild(img);
    }
  });
}

function undoLastStep(){
  if(history.length===0) return;
  const prev = history.pop();
  circuit = prev.circuit; currentMap = prev.currentMap;
  renderGateList(); renderCircuitVisualization();
  restoreFishPositions(prev.fish);
  steps = Math.max(0, steps-1); stepDisplay.textContent = `æ­¥æ•¸ï¼š${steps}`;
  updateUndoButton();
}
function updateUndoButton(){ undoBtn.disabled = history.length === 0; }

function renderCircuitVisualization(){
  const c = document.getElementById("circuitVisualization"); c.innerHTML = "";
  for(let i=0; i<bitCount; i++){
    const line = document.createElement("div"); line.className="circuit-line";
    line.innerHTML = `<div class="circuit-line-label">q${i}</div><div class="circuit-line-path" id="circuit-line-${i}"></div>`;
    c.appendChild(line);
  }
  const GRID = 25;
  circuit.forEach((gate,idx)=>{
    const pos = GRID*(idx+1);
    if(gate.type==="X") addXGate(gate.target, pos);
    else if(gate.type==="CNOT") addCNOTGate(gate.control, gate.target, pos, false);
    else if(gate.type==="0CNOT") addCNOTGate(gate.control, gate.target, pos, true);
    else if(gate.type==="CCNOT") addCCNOTGate(gate, pos);
    else if(gate.type==="MCNOT") addMCNOTGate(gate, pos);
  });
}

function addXGate(t,p){ const l=document.getElementById(`circuit-line-${t}`); const g=document.createElement("div"); g.className="circuit-gate"; g.textContent="X"; g.style.left=p+"px"; l.appendChild(g); }

function addCNOTGate(c, t, p, hollow) {
    const ROW_H = 33;
    const min = Math.min(c, t);
    const max = Math.max(c, t);
    const topPos = (min * ROW_H) + 12.5;
    const height = (max - min) * ROW_H;
    const container = document.getElementById("circuitVisualization");
    const conn = document.createElement("div");
    conn.className = "circuit-connector";
    conn.style.left = (46 + p) + "px";
    conn.style.top = (topPos+5) + "px";
    conn.style.height = (height-10) + "px";
    conn.style.transform = "none";
    container.appendChild(conn);
   
    const cl = document.getElementById(`circuit-line-${c}`);
    const cd = document.createElement("div");
    cd.className = hollow ? "circuit-control hollow" : "circuit-control";
    cd.style.left = p + "px";
    cl.appendChild(cd);
   
    const tl = document.getElementById(`circuit-line-${t}`);
    const td = document.createElement("div");
    td.className = "circuit-target";
    td.style.left = (p - 2.2) + "px";
    tl.appendChild(td);
}

function addCCNOTGate(g, p) {
    const ROW_H = 33;
    const lines = [g.control1, g.control2, g.target].sort((a, b) => a - b);
    const min = lines[0];
    const max = lines[lines.length-1];
    const topPos = (min * ROW_H) + 12.5;
    const height = (max - min) * ROW_H;
   
    const container = document.getElementById("circuitVisualization");
    const conn = document.createElement("div");
    conn.className = "circuit-connector";
    conn.style.left = (46 + p) + "px";
    conn.style.top = (topPos+5) + "px";
    conn.style.height = (height-10) + "px";
    conn.style.transform = "none";
    container.appendChild(conn);
   
    const c1l = document.getElementById(`circuit-line-${g.control1}`);
    const c1d = document.createElement("div");
    c1d.className = g.c1Val === 0 ? "circuit-control hollow" : "circuit-control";
    c1d.style.left = p + "px";
    c1l.appendChild(c1d);
   
    const c2l = document.getElementById(`circuit-line-${g.control2}`);
    const c2d = document.createElement("div");
    c2d.className = g.c2Val === 0 ? "circuit-control hollow" : "circuit-control";
    c2d.style.left = p + "px";
    c2l.appendChild(c2d);
   
    const tl = document.getElementById(`circuit-line-${g.target}`);
    const td = document.createElement("div");
    td.className = "circuit-target";
    td.style.left = (p - 2.2) + "px";
    tl.appendChild(td);
}

function addMCNOTGate(g, p) {
    const ROW_H = 33;
    const involved = g.controls.map(c => c.bit).concat([g.target]).sort((a,b)=>a-b);
    const min = involved[0];
    const max = involved[involved.length-1];
   
    const topPos = (min * ROW_H) + 12.5;
    const height = (max - min) * ROW_H;
   
    const container = document.getElementById("circuitVisualization");
    const conn = document.createElement("div");
    conn.className = "circuit-connector";
    conn.style.left = (46 + p) + "px";
    conn.style.top = (topPos+5) + "px";
    conn.style.height = (height-10) + "px";
    conn.style.transform = "none";
    container.appendChild(conn);

    g.controls.forEach(c => {
        const line = document.getElementById(`circuit-line-${c.bit}`);
        const dot = document.createElement("div");
        dot.className = c.val === 0 ? "circuit-control hollow" : "circuit-control";
        dot.style.left = p + "px";
        line.appendChild(dot);
    });

    const tl = document.getElementById(`circuit-line-${g.target}`);
    const td = document.createElement("div");
    td.className = "circuit-target";
    td.style.left = (p - 2.2) + "px";
    tl.appendChild(td);
}

function applyGateAndAnimate(gate){
  saveStateToHistory();
  addGateToList(gate);
  const size = 1 << bitCount;
  currentMap = Array.from({length:size}, (_,i)=>applyGateToIndex(i, gate));
  const perm = Array.from({length:size}, (_,i)=>applyGateToIndex(i, gate));
 
  perm.forEach((to,from)=>{
    if(to === from) return;

    let pidFrom, pidTo;
   
    // ä¿®æ­£è¡Œæ˜Ÿ ID ç”Ÿæˆé‚è¼¯
    if (bitCount === 1) {
      // 1bit ä½¿ç”¨ planet1, planet2
      pidFrom = "planet" + (from + 1);
      pidTo = "planet" + (to + 1);
    } else if (bitCount === 2) {
      // 2bit ä¹Ÿä½¿ç”¨ planet1-4
      pidFrom = "planet" + (from + 1);
      pidTo = "planet" + (to + 1);
    } else {
      // 3bit å’Œ 4bit ä½¿ç”¨ planet0, planet1...
      pidFrom = "planet" + from;
      pidTo = "planet" + to;
    }

    const fish = planets[pidFrom]?.querySelector(".person");
    if(!fish) return;
   
    const r1 = planets[pidFrom].getBoundingClientRect();
    const r2 = planets[pidTo].getBoundingClientRect();
    const dx = r2.left - r1.left, dy = r2.top - r1.top;
   
    fish.style.transform = `translate(${dx}px,${dy}px) translate(-50%,-50%)`;
    setTimeout(()=>{
        if(planets[pidTo]) {
            planets[pidTo].appendChild(fish);
            fish.style.transform="translate(-50%,-50%)";
            // ç§»é™¤åŸæœ¬ç§»å‹•æ™‚è®Šæ·¡çš„é‚è¼¯ï¼Œä¿æŒé­šåŸæœ¬çš„èº«ä»½æ¨£å¼ (Ghost æ°¸é æ˜¯ Ghost)
        }
        checkSuccess();
    }, 800);
  });
  steps++; stepDisplay.textContent = `æ­¥æ•¸ï¼š${steps}`;
  updateUndoButton();
}

function getCurrentLevel(){ return bitLevels[bitCount][currentLevel]; }

function loadLevel(idx){
  document.getElementById("levelNumber").textContent = `é¡Œç›®ï¼š${idx+1}`;
  container.querySelectorAll(".planet").forEach(p=>p.remove());
  svg.innerHTML=""; planets = {};
  const level = getCurrentLevel();
 
  let planetSize = 140;
  if (bitCount===3) planetSize = 90;
  if (bitCount===4) planetSize = 70;

  if (bitCount===4) {
      container.style.width = "900px";
      container.style.height = "550px";
  } else if (bitCount===3) {
      container.style.width = "600px";
      container.style.height = "600px";
  } else {
      container.style.width = "420px";
      container.style.height = "420px";
  }

  level.planets.forEach(p=>{
    const div = document.createElement("div");
    div.className = "planet";
    if(p.isFaded) div.classList.add("faded");
    div.id = p.id;
    div.style.top = p.top+"px"; div.style.left = p.left+"px";
    div.style.width = div.style.height = planetSize+"px";
    if(p.label) div.setAttribute("data-label", p.label);
   
    const img = document.createElement("img");
    if(bitCount===4) {
         img.src = raw4 + p.key + ".png";
    } else if (bitCount===3) {
         img.src = planetImg3[p.key];
    } else if (bitCount === 2) {
         // 2bit ä½¿ç”¨å°æ‡‰çš„åœ–ç‰‡
         img.src = planetImg[p.key];
    } else {
         // 1bit
         img.src = planetImg[p.key];
    }
    div.appendChild(img);
    container.appendChild(div);
    planets[p.id] = div;
  });
 
  const offset = planetSize / 2;
  level.lines.forEach(([id,p1,p2,isHyper])=>{
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    const pl1 = level.planets.find(x=>x.id===p1);
    const pl2 = level.planets.find(x=>x.id===p2);
    line.setAttribute("x1",pl1.left+offset); line.setAttribute("y1",pl1.top+offset);
    line.setAttribute("x2",pl2.left+offset); line.setAttribute("y2",pl2.top+offset);
    line.style.stroke = "#555";
    line.style.strokeWidth = "4";
    if(isHyper) line.classList.add("hyper-line");

    svg.appendChild(line);
   
    line.addEventListener("mouseenter",()=>{
        line.style.stroke="#ffcc00";
        line.style.strokeWidth="8";
    });
    line.addEventListener("mouseleave",()=>{
        line.style.stroke = isHyper ? "#999" : "#555";
        line.style.strokeWidth = isHyper ? "3" : "4";
    });
    line.addEventListener("click",()=>onLineClick(p1,p2));
  });

  princes = JSON.parse(JSON.stringify(level.princes));
  placePrincesByFixedArrangement(idx);
  steps = 0; stepDisplay.textContent = "æ­¥æ•¸ï¼š0";
  startTimer(); renderCircuitVisualization(); history = []; updateUndoButton();
}

function placePrincesByFixedArrangement(idx){
  Object.values(planets).forEach(p => p.querySelectorAll(".person").forEach(img => img.remove()));
 
  if(bitCount===4){
     const perm = permList4bit[idx] || permList4bit[0];
     
     perm.forEach((fishIdx, pos)=>{
         const img = document.createElement("img");
         
         const fishKeyStr = fishIdx.toString(2).padStart(4, "0");
         img.src = raw4 + fishKeyStr + "Fish.png";
         
         img.className = "person";
         
         // é—œéµä¿®æ”¹ï¼šä¸çœ‹ä½ç½® (pos)ï¼Œåªçœ‹é­šçš„èº«åˆ† (fishIdx)
         // å¦‚æœé€™æ¢é­šçš„ç›®æ¨™æ˜¯ 8-15 (å³é‚Šæ­£æ–¹é«”)ï¼Œå®ƒå°±æ˜¯è™›æ“¬é­šï¼Œæ°¸é ä¿æŒæ·¡åŒ–
         if(fishIdx >= 8) {
             img.classList.add("ghost-fish");
             img.style.opacity = "1"; // ä¿®æ”¹ï¼šæ”¹å› 1 (åŸæœ¬æ˜¯ 0.55)
             img.style.filter = "grayscale(40%) sepia(20%)";
         } else {
             // å¯¦é«”é­šï¼Œä¿æŒåŸæ¨£
             img.style.opacity = "1";
             img.style.filter = "none";
         }
         
         if(planets[`planet${pos}`]) planets[`planet${pos}`].appendChild(img);
     });

  } else if(bitCount===3){
    const perm = permList3bit[idx];
    const order = ["3flowerFish","BobFish","KuroverFish","SiamFish","BlackFish","BinsFish","SakabanFish","WhiteFish"];
    const ids = ["planet0","planet1","planet2","planet3","planet4","planet5","planet6","planet7"];
    perm.forEach((fishIdx,pos)=>{
      const img = document.createElement("img");
      img.src = fishImg3[order[fishIdx]];
      img.className = "person";
      planets[ids[pos]].appendChild(img);
    });
  } else if(bitCount===1){
    const ids = ["planet1","planet2"];
    const fishList = [fishImg["3flowerFish"], fishImg["BobFish"]];
    fishList.forEach((src, i) => {
        const img = document.createElement("img");
        img.src = src;
        img.className = "person";
        planets[ids[i]].appendChild(img);
    });
  } else if(bitCount===2){
    // ä¿®æ­£ 2bit çš„æ’åˆ—æ–¹å¼
    const perm = permList[idx];
    const fishOrder = [fishImg["3flowerFish"], fishImg["BobFish"], fishImg["KuroFish"], fishImg["dollFish"]];
    const ids = ["planet1","planet2","planet3","planet4"]; // 2bit ä½¿ç”¨ planet1-4
    
    perm.forEach((fishIdx,pos)=>{
      const img = document.createElement("img");
      img.src = fishOrder[fishIdx];
      img.className = "person";
      planets[ids[pos]].appendChild(img);
    });
  }
}

function checkSuccess(){
  const ok = princes.every(p=>{
    const img = planets[p.target].querySelector(".person");
    if(!img) return false;
    return img.src === p.img || decodeURIComponent(img.src) === decodeURIComponent(p.img);
  });
  
  if(ok){ 
      clearInterval(timerInterval); 
      const time = Math.floor((Date.now()-startTime)/1000);
      
      // æ›´æ–°æˆåŠŸè¨Šæ¯
      document.getElementById("successMessage").innerHTML = 
          `å“‡ï¼<span style="color: var(--earth-coffee); font-weight: bold;">${currentPlayer.name}</span>ï¼Œä½ èµ°äº† <span style="color: var(--earth-coffee); font-weight: bold;">${steps}</span> æ­¥ï¼ŒèŠ±äº† <span style="color: var(--earth-coffee); font-weight: bold;">${time}</span> ç§’ï¼Œè®“æ¯éš»è²“éƒ½åƒåˆ°å°æ‡‰çš„é­šè€¶~`;
      
      // å„²å­˜åˆ†æ•¸åˆ°æ’è¡Œæ¦œ
      addScoreToLeaderboard(steps, time, currentLevel, bitCount);
      
      showPopup(steps, time); 
  }
}

function startTimer(){
  clearInterval(timerInterval);
  startTime = Date.now();
  timerInterval = setInterval(()=>{ timerDisplay.textContent = `æ™‚é–“ï¼š${Math.floor((Date.now()-startTime)/1000)} ç§’`; },1000);
}
function showPopup(s,t){ document.getElementById("successPopup").style.display = "flex"; }
function softResetFish(){ steps=0; stepDisplay.textContent="æ­¥æ•¸ï¼š0"; placePrincesByFixedArrangement(currentLevel); startTimer(); history=[]; updateUndoButton(); }

function onLineClick(p1Str, p2Str) {
  let p1, p2;
  
  if (bitCount === 1) {
    applyGateAndAnimate({ type: "X", target: 0 });
    return;
  }
  
  // ä¿®æ­£ 2bit çš„è¡Œæ˜Ÿ ID è§£æ
  if (bitCount === 2) {
    // 2bit çš„è¡Œæ˜Ÿ ID æ˜¯ "planet1", "planet2", "planet3", "planet4"
    // ä½†ç‹€æ…‹ç´¢å¼•æ˜¯å¾ 0 é–‹å§‹ (00, 01, 10, 11)
    // æ‰€ä»¥éœ€è¦å°‡ planet1-4 è½‰æ›æˆ 0-3
    p1 = parseInt(p1Str.replace("planet", "")) - 1;
    p2 = parseInt(p2Str.replace("planet", "")) - 1;
    
    const gate = generateGateFromTransition(p1, p2, bitCount);
    if(gate) {
        applyGateAndAnimate(gate);
    }
    return;
  }
  
  // 3bit å’Œ 4bit çš„è¡Œæ˜Ÿ ID å·²ç¶“æ˜¯ "planet0", "planet1" ç­‰
  if (bitCount === 3 || bitCount === 4) {
    p1 = parseInt(p1Str.replace("planet", ""));
    p2 = parseInt(p2Str.replace("planet", ""));
    
    const gate = generateGateFromTransition(p1, p2, bitCount);
    if(gate) applyGateAndAnimate(gate);
    return;
  }
}

function generateGateFromTransition(s1, s2, bits) {
    const b1 = stateIndexToBits(s1);
    const b2 = stateIndexToBits(s2);

    let target = -1;
    const controls = [];

    for(let i=0; i<bits; i++){
        if(b1[i] !== b2[i]) {
            if(target !== -1) return null;
            target = i;
        } else {
            controls.push({bit: i, val: b1[i]});
        }
    }

    if(target === -1) return null;

    if (controls.length === 1) {
        const c = controls[0];
        return {
            type: c.val === 1 ? "CNOT" : "0CNOT",
            control: c.bit,
            target: target
        };
    } else if (controls.length === 2) {
        return {
            type: "CCNOT",
            control1: controls[0].bit, c1Val: controls[0].val,
            control2: controls[1].bit, c2Val: controls[1].val,
            target: target
        };
    } else {
        return {
            type: "MCNOT",
            controls: controls,
            target: target
        };
    }
}

// æˆåŠŸå½ˆçª—é—œé–‰æŒ‰éˆ•
document.getElementById("closePopup").onclick = ()=>{ 
    document.getElementById("successPopup").style.display="none"; 
    resetCircuit(); 
};

document.getElementById("resetBtn").onclick = ()=>{ resetCircuit(); };

document.getElementById("bitSelector").onchange = (e)=>{
  bitCount = parseInt(e.target.value);
  currentLevel = 0;
  circuit = [];
  renderGateButtons();
  loadLevel(currentLevel);
  resetCircuit();
  
  // æ›´æ–°æ’è¡Œæ¦œé¡¯ç¤º
  updateLeaderboardDisplay(bitCount);
};

let animating=false;
function transitionLevel(next,dir){
  if(animating) return; animating=true;
  container.classList.add(dir==="left"?"slide-out-left":"slide-out-right");
  setTimeout(()=>{
    currentLevel = next;
    loadLevel(currentLevel);
    container.classList.remove("slide-out-left","slide-out-right");
    container.classList.add(dir==="left"?"slide-in-right":"slide-in-left");
    setTimeout(()=>{ container.classList.remove("slide-in-right","slide-in-left"); animating=false; },620);
  },320);
}

document.getElementById("prevBtn").onclick = ()=>{ 
    const L=bitLevels[bitCount].length; 
    transitionLevel((currentLevel-1+L)%L,"left"); 
    resetCircuit(); 
};

document.getElementById("nextBtn").onclick = ()=>{ 
    const L=bitLevels[bitCount].length; 
    transitionLevel((currentLevel+1)%L,"right"); 
    resetCircuit(); 
};

const toggleBtn = document.getElementById('toggleCircuitBtn');
let hidden = false;
toggleBtn.addEventListener('click', ()=>{ hidden=!hidden; document.body.classList.toggle('hide-circuit-mode',hidden); });
document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='h') toggleBtn.click(); });

renderGateButtons();
loadLevel(currentLevel);
</script>
</body>
</html>

