<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è²“è²“æ˜Ÿçƒ</title>
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* ä¿æŒä¸­ä¸Šä½ˆå±€ */
        padding-top: 0;
        padding-bottom: 160px;
        height: 100vh;
        background: #d6cc98;
        font-family: sans-serif;
        overflow: hidden;
        transition: all 0.4s ease;
    }
    body {
        margin: 0;
        overflow: hidden;
        background-image: url("https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=2000&q=80");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    #gameWrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 640px;
        position: relative;
        z-index: 50;
    }
    #container {
        position: relative;
        width: 420px;
        height: 420px;
        overflow: visible;
        margin: 0 auto;
        transition: all 0.4s ease;
    }
    .planet {
        position: absolute;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,.2);
        transition: all 0.4s ease;
        z-index: 10;
    }
    .planet img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    /* 3bit å°ˆç”¨æ¨™ç±¤ */
    .planet[data-label]::after {
        content: attr(data-label);
        position: absolute;
        top: -25px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
    }
    svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: auto;
        overflow: visible;
    }
    line {
        stroke: #555;
        stroke-width: 5;
        cursor: pointer;
        transition: stroke .3s;
    }
    line:hover {
        stroke: #000;
    }
    .person {
        width: 90px;
        height: 90px;
        object-fit: contain;
        pointer-events: none;
        transition: transform .8s ease;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        transition: all 0.4s ease;
        z-index: 20;
    }

    .left-panel {
        position: absolute;
        left: 10px;
        top: 12vh;
        width: 220px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        font-size: 14px;
        color: #1e293b;
        z-index: 100;
        max-height: 75vh;
        overflow-y: auto;
        transition: all 0.4s ease;
    }
    .left-panel h3 { margin: 0 0 10px; font-size: 15px; text-align: center; color: #1e293b; }
    #info { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; }
    #levelNumber { font-size: 1.2rem; font-weight: bold; color: #333; }
    #steps { font-size: 1.1rem; font-weight: bold; color: #333; }
    #timer { font-size: 1rem; color: #444; }
    #buttons { display: flex; justify-content: center; gap: 10px; margin-top: 15px; width: 100%; }
    #resetBtn { padding: 8px 16px; background: #7a654f; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    #resetBtn:hover { background: #5c4d3a; }
    #prevBtn, #nextBtn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #f1f1f1b1; color: #7a654f; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background .3s; }
    #prevBtn:hover, #nextBtn:hover { background: #5c4d3a; color: #fff; }
    #prevBtn::before { content: ""; display: block; width: 0; height: 0; border: 12px solid transparent; border-right-color: #7a654f; margin-left: -5px; }
    #nextBtn::before { content: ""; display: block; width: 0; height: 0; border: 12px solid transparent; border-left-color: #7a654f; margin-left: 5px; }
    #prevBtn:hover::before { border-right-color: #fff; }
    #nextBtn:hover::before { border-left-color: #fff; }
    @media (max-width: 768px) {
        #container { width: 380px; height: 380px; }
        .planet { width: 120px; height: 120px; }
        .person { width: 80px; height: 80px; }
        body { padding-bottom: 200px; }
        .left-panel { top: 60px; }
    }
    .slide-out-left { animation: slideOutLeft .6s forwards; }
    .slide-in-right { animation: slideInRight .6s forwards; }
    .slide-out-right { animation: slideOutRight .6s forwards; }
    .slide-in-left { animation: slideInLeft .6s forwards; }
    @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .popup { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn .3s ease; }
    .popup-content { background: #fff; border-radius: 20px; padding: 30px 40px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,.3); animation: popUp .4s ease; max-width: 90%; }
    .popup-content h2 { margin: 8px 0 10px; }
    .popup-content button { background: #ffb60b; color: #fff; border: none; border-radius: 12px; padding: 10px 20px; cursor: pointer; font-size: 16px; transition: background .2s; }
    .popup-content button:hover { background: #ff750b; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popUp { from { transform: scale(.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .gate-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; }
    .gate-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
    .gate-btn { flex: 1 1 45%; padding: 6px 8px; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.08); text-align: center; }
    .gate-btn:hover { background: #f8fafc; box-shadow: 0 3px 8px rgba(0,0,0,.1); }
    .gate-list { display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0; max-height: 80px; overflow-y: auto; }
    .gate-badge { display: flex; align-items: center; gap: 5px; padding: 3px 7px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; font-family: ui-monospace, monospace; font-size: 11px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
    .gate-badge .remove { width: 15px; height: 15px; background: #ef4444; color: #fff; border: none; border-radius: 50%; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .gate-badge .remove:hover { background: #dc2626; }
    .reset-circuit-btn { width: 100%; margin-top: 8px; padding: 6px; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 12px; cursor: pointer; }
    .reset-circuit-btn:hover { background: #f8fafc; }
    #undoBtn { padding: 8px 16px; background: #7a654f; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 10px; width: 100%; }
    #undoBtn:hover { background: #5c4d3a; }
    #undoBtn:disabled { background: #cccccc; cursor: not-allowed; }
    
    .circuit-panel { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 3000px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; padding: 14px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); font-size: 14px; color: #1e293b; z-index: 100; transition: all 0.4s ease; }
    .circuit-panel h3 { margin: 0 0 10px; font-size: 15px; color: #1e293b; text-align: center; }
    /* ä¿®æ­£ï¼šåŠ ä¸Š relative è®“çµ•å°å®šä½çš„é€£æ¥ç·šå¯ä»¥æ­£ç¢ºå°é½Šå®¹å™¨ */
    .circuit-visualization { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; position: relative; }
    .circuit-line { display: flex; align-items: center; height: 25px; position: relative; z-index: 10;}
    .circuit-line-label { width: 30px; text-align: center; font-weight: bold; font-size: 12px; }
    .circuit-line-path { flex: 1; height: 2px; background: #111111; position: relative; margin: 0 10px; }
    .circuit-gate { position: absolute; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border-radius: 4px; background: #7a654f; color: white; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; }
    .circuit-control { position: absolute; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; border-radius: 50%; background: #111111; border: 2px solid #000000; }
    .circuit-control.hollow { background: white !important; border: 2px solid #000000 !important; }
    .circuit-target { position: absolute; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; border-radius: 50%; color: #111111; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
    .circuit-target::after { content: "âŠ•"; }
    .circuit-connector { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 2px; height: 100%; background: #111111; z-index: 1;}
    .hide-circuit-mode .left-panel, .hide-circuit-mode .circuit-panel { transform: translateX(-120%) !important; opacity: 0; pointer-events: none; }
    .hide-circuit-mode .circuit-panel { transform: translateY(120%) !important; }
    .toggle-circuit-btn { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: rgba(122, 101, 79, 0.9); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(8px); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .toggle-circuit-btn:hover { background: #5c4d3a; transform: scale(1.1); }
    .toggle-circuit-btn::before { content: "âš¡"; }
    .hide-circuit-mode .toggle-circuit-btn::before { content: "ğŸ‘ï¸"; }
</style>
</head>
<body>
<div id="gameWrapper">
  <h2 style="margin:10px 0 5px;">è²“è²“æ˜Ÿçƒ</h2>
  <div id="container"><svg></svg></div>
  <div id="buttons">
    <button id="prevBtn"></button>
    <button id="resetBtn">é‡æ–°é–‹å§‹</button>
    <button id="nextBtn"></button>
  </div>
</div>

<div class="left-panel">
  <h3>éŠæˆ²è³‡è¨Š</h3>
  <div id="info">
    <div id="levelNumber">é¡Œç›®ï¼š1</div>
    <div id="steps">æ­¥æ•¸ï¼š0</div>
    <div id="timer">æ™‚é–“ï¼š0 ç§’</div>
  </div>
  <div class="gate-section">
    <h3>é¸æ“‡ BIT æ•¸</h3>
    <select id="bitSelector">
      <option value="1">1 BIT</option>
      <option value="2" selected>2 BIT</option>
      <option value="3">3 BIT (8 è²“å’ª)</option>
    </select>
    <h3 style="margin-top:10px;">æ–°å¢é‡å­é–˜é–€</h3>
    <div class="gate-btns">
      </div>
    <h3 style="margin-top:10px;">ç›®å‰é›»è·¯</h3>
    <div id="gateList" class="gate-list"></div>
    <button class="reset-circuit-btn" onclick="resetCircuit()">é‡è¨­é›»è·¯</button>
    <button id="undoBtn" onclick="undoLastStep()" disabled>å›åˆ°ä¸Šä¸€æ­¥</button>
  </div>
</div>

<div class="circuit-panel">
  <h3>é›»è·¯åœ–</h3>
  <div id="circuitVisualization" class="circuit-visualization"></div>
</div>

<div id="successPopup" class="popup">
  <div class="popup-content">
    <h2>Congratulations æˆåŠŸï¼</h2>
    <p></p><br>
    <button id="closePopup">å†ç©ä¸€æ¬¡</button>
  </div>
</div>

<button class="toggle-circuit-btn" id="toggleCircuitBtn" title="åˆ‡æ›éš±è—é›»è·¯æ¨¡å¼ï¼ˆæˆ–æŒ‰ H éµï¼‰"></button>

<script>
/* ==================== åŸå§‹ 1/2 bit åœ–ç‰‡èˆ‡è³‡æ–™ ==================== */
const raw = "https://raw.githubusercontent.com/s112321005/little_prince/main/";
const planetImg = {
  "3flower": raw+"3flower_00.png",
  "Bob":     raw+"Bob_01.png",
  "Kurover": raw+"Kurover_10.png",
  "doll":    raw+"doll_11.png"
};
const fishImg = {
  "3flowerFish": raw+"3flowerFish.png",
  "BobFish":     raw+"BobFish.png",
  "KuroFish":    raw+"KuroFish.png",
  "dollFish":    raw+"dollFish%20.png"
};

/* ==================== 3 bit åœ–ç‰‡èˆ‡è³‡æ–™ ==================== */
const raw3 = "https://raw.githubusercontent.com/s112321005/little_prince/main/3bit/";
const planetImg3 = {
  "3flower": raw3+"3flower_000.png",
  "Bob":     raw3+"Bob_001.png",
  "Kurover": raw3+"Kurover_010.png",
  "Siam":    raw3+"Siam_011.png",
  "Black":   raw3+"Black_100.png",
  "Bins":    raw3+"Bins_101.png",
  "Sakaban": raw3+"Sakaban_110.png",
  "White":   raw3+"White_111.png"
};
const fishImg3 = {
  "3flowerFish": raw3+"3flowerFish.png",
  "BobFish":     raw3+"BobFish.png",
  "KuroverFish": raw3+"KuroFish.png",
  "SiamFish":    raw3+"SiamFish.png",
  "BlackFish":   raw3+"BlackFish.png",
  "BinsFish":    raw3+"BinsFish.png",
  "SakabanFish": raw3+"SakabanFish.png",
  "WhiteFish":   raw3+"WhiteFish.png"
};

/* ==================== åŸå§‹ 24 å€‹ 2bit æ’åˆ— ==================== */
const permList = [
  "0132","0213","0231","0312","0321",
  "1023","1032","1203","1230","1302","1320",
  "2013","2031","2103","2130","2301","2310",
  "3012","3021","3102","3120","3201","3210"
].map(s => s.split("").map(Number));

/* ==================== 3bit éš¨æ©Ÿæ’åˆ— ==================== */
function gen3bitPerm() {
  let a = [0,1,2,3,4,5,6,7];
  for (let i=7; i>0; i--) {
    let j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
const permList3bit = Array.from({length: 30}, gen3bitPerm);

/* ==================== é—œå¡è³‡æ–™ ==================== */
let bitCount = 2;
const bitLevels = {
  1: [{ /* ä½ åŸæœ¬ 1bit è³‡æ–™ */ 
    planets: [{id:"planet1", key:"3flower", top:140, left:20}, {id:"planet2", key:"Bob", top:140, left:260}],
    princes: [{img: fishImg["3flowerFish"], target:"planet1"}, {img: fishImg["BobFish"], target:"planet2"}],
    lines:[["line12","planet1","planet2"]]
  }],
  2: Array.from({length: permList.length}, () => ({
    planets: [
      {id:"planet1", key:"3flower", top:0,   left:0},
      {id:"planet2", key:"Bob",     top:0,   left:280},
      {id:"planet3", key:"Kurover", top:280, left:0},
      {id:"planet4", key:"doll",    top:280, left:280}
    ],
    princes: [
      {img: fishImg["3flowerFish"], target:"planet1"},
      {img: fishImg["BobFish"],     target:"planet2"},
      {img: fishImg["KuroFish"],    target:"planet3"},
      {img: fishImg["dollFish"],    target:"planet4"}
    ],
    lines: [["line12","planet1","planet2"],["line13","planet1","planet3"],["line24","planet2","planet4"],["line34","planet3","planet4"]]
  })),
  3: permList3bit.map(() => ({
    // 3bit ä½ç½®æ‹‰é–‹
    planets: [
      // å…§å±¤ (0xx)
      {id:"planet0", key:"3flower", label:"000", top:140, left:140},
      {id:"planet1", key:"Bob",     label:"001", top:140, left:340},
      {id:"planet2", key:"Kurover", label:"010", top:340, left:140},
      {id:"planet3", key:"Siam",    label:"011", top:340, left:340},
      // å¤–å±¤ (1xx) - å¾€å¤–æ“´å¼µ
      {id:"planet4", key:"Black",   label:"100", top:20,  left:20},
      {id:"planet5", key:"Bins",    label:"101", top:20,  left:460},
      {id:"planet6", key:"Sakaban", label:"110", top:460, left:20},
      {id:"planet7", key:"White",   label:"111", top:460, left:460}
    ],
    princes: [
      {img: fishImg3["3flowerFish"], target:"planet0"},
      {img: fishImg3["BobFish"],     target:"planet1"},
      {img: fishImg3["KuroverFish"], target:"planet2"},
      {img: fishImg3["SiamFish"],    target:"planet3"},
      {img: fishImg3["BlackFish"],   target:"planet4"},
      {img: fishImg3["BinsFish"],    target:"planet5"},
      {img: fishImg3["SakabanFish"], target:"planet6"},
      {img: fishImg3["WhiteFish"],   target:"planet7"}
    ],
    lines: [
      ["l01","planet0","planet1"],["l02","planet0","planet2"],["l13","planet1","planet3"],["l23","planet2","planet3"],
      ["l45","planet4","planet5"],["l46","planet4","planet6"],["l57","planet5","planet7"],["l67","planet6","planet7"],
      ["l04","planet0","planet4"],["l15","planet1","planet5"],["l26","planet2","planet6"],["l37","planet3","planet7"]
    ]
  }))
};

/* ==================== æ ¸å¿ƒè®Šæ•¸ ==================== */
let currentLevel = 0, steps = 0, startTime, timerInterval;
let circuit = [], currentMap = [];
let planets = {}, princes = [];
let history = [];
const stepDisplay = document.getElementById("steps");
const timerDisplay = document.getElementById("timer");
const container = document.getElementById("container");
const svg = container.querySelector("svg");
const undoBtn = document.getElementById("undoBtn");

/* ==================== å·¥å…·å‡½æ•¸ ==================== */
function stateIndexToBits(i) { return i.toString(2).padStart(bitCount,"0").split("").map(Number); }
function bitsToStateIndex(bits) { return parseInt(bits.join(""),2); }

function applyGateToIndex(stateIndex, gate){
  const b = stateIndexToBits(stateIndex);
  const nb = b.slice();
  switch(gate.type){
    case "X": 
      nb[gate.target] ^= 1; 
      break;
    case "CNOT": 
      if(nb[gate.control]) nb[gate.target] ^= 1; 
      break;
    case "0CNOT": 
      if(nb[gate.control]===0) nb[gate.target] ^= 1; 
      break;
    case "CCNOT":
      const c1Ok = (gate.c1Val === 1) ? (nb[gate.control1] === 1) : (nb[gate.control1] === 0);
      const c2Ok = (gate.c2Val === 1) ? (nb[gate.control2] === 1) : (nb[gate.control2] === 0);
      if(c1Ok && c2Ok) {
        nb[gate.target] ^= 1;
      }
      break;
  }
  return bitsToStateIndex(nb);
}

/* ==================== å‹•æ…‹ç”¢ç”ŸæŒ‰éˆ• ==================== */
function renderGateButtons(){
  const box = document.querySelector(".gate-btns");
  box.innerHTML = "";
  const gates = bitCount === 3 ? [
    {text:"X q0", g:{type:"X",target:0}},
    {text:"X q1", g:{type:"X",target:1}},
    {text:"X q2", g:{type:"X",target:2}},
    {text:"1CNOT q0â†’q1", g:{type:"CNOT",control:0,target:1}},
    {text:"1CNOT q1â†’q0", g:{type:"CNOT",control:1,target:0}},
    {text:"1CNOT q0â†’q2", g:{type:"CNOT",control:0,target:2}},
    {text:"1CNOT q2â†’q0", g:{type:"CNOT",control:2,target:0}},
    {text:"1CNOT q1â†’q2", g:{type:"CNOT",control:1,target:2}},
    {text:"1CNOT q2â†’q1", g:{type:"CNOT",control:2,target:1}},
    {text:"0CNOT q0â†’q1", g:{type:"0CNOT",control:0,target:1}},
    {text:"0CNOT q1â†’q0", g:{type:"0CNOT",control:1,target:0}},
    {text:"0CNOT q0â†’q2", g:{type:"0CNOT",control:0,target:2}},
    {text:"0CNOT q2â†’q0", g:{type:"0CNOT",control:2,target:0}},
    {text:"0CNOT q1â†’q2", g:{type:"0CNOT",control:1,target:2}},
    {text:"0CNOT q2â†’q1", g:{type:"0CNOT",control:2,target:1}}
  ] : [
    {text:"X q0", g:{type:"X",target:0}},
    {text:"X q1", g:{type:"X",target:1}},
    {text:"1CNOT q0â†’q1", g:{type:"CNOT",control:0,target:1}},
    {text:"1CNOT q1â†’q0", g:{type:"CNOT",control:1,target:0}},
    {text:"0CNOT q0â†’q1", g:{type:"0CNOT",control:0,target:1}},
    {text:"0CNOT q1â†’q0", g:{type:"0CNOT",control:1,target:0}}
  ];
  gates.forEach(o=>{
    const b = document.createElement("button");
    b.className="gate-btn";
    b.textContent = o.text;
    b.onclick = ()=>applyGateAndAnimate(o.g);
    box.appendChild(b);
  });
}

/* ==================== å…¶é¤˜å‡½æ•¸ ==================== */
function addGateToList(g){ circuit.push(g); renderGateList(); renderCircuitVisualization(); }
function resetCircuit(){
  saveStateToHistory();
  circuit = []; 
  currentMap = Array.from({length: 1<<bitCount}, (_,i)=>i);
  renderGateList(); 
  renderCircuitVisualization(); 
  softResetFish(); 
  updateUndoButton();
}
function renderGateList(){
  const box = document.getElementById("gateList"); box.innerHTML = "";
  circuit.forEach((g,idx)=>{
    const el = document.createElement("div"); el.className = "gate-badge";
    let label = "";
    if(g.type==="X") label = `X q${g.target}`;
    else if(g.type==="CNOT") label = `1CNOT q${g.control}â†’q${g.target}`;
    else if(g.type==="0CNOT") label = `0CNOT q${g.control}â†’q${g.target}`;
    else if(g.type==="CCNOT") {
      label = `${g.c1Val}${g.c2Val}CNOT q${g.control1},q${g.control2}â†’q${g.target}`;
    }
    el.innerHTML = `<span>${label}</span>`;
    const x = document.createElement("button"); x.className="remove"; x.textContent="x";
    x.onclick = ()=>{ saveStateToHistory(); circuit.splice(idx,1); renderGateList(); renderCircuitVisualization(); updateUndoButton(); };
    el.appendChild(x); box.appendChild(el);
  });
}
/* æ­·å²èˆ‡ undo */
function saveStateToHistory() {
  const state = { circuit: JSON.parse(JSON.stringify(circuit)), currentMap: [...currentMap], fish: getCurrentFishPositions() };
  history.push(state);
  if(history.length > 50) history.shift();
  updateUndoButton();
}
function getCurrentFishPositions(){
  const pos = {};
  Object.keys(planets).forEach(id=>{ const f = planets[id].querySelector(".person"); if(f) pos[id] = f.src; });
  return pos;
}
function restoreFishPositions(pos){
  Object.values(planets).forEach(p=>p.querySelectorAll(".person").forEach(img=>img.remove()));
  Object.entries(pos).forEach(([id,src])=>{
    if(planets[id]){
      const img = document.createElement("img");
      img.src = src; img.className = "person";
      planets[id].appendChild(img);
    }
  });
}
function undoLastStep(){
  if(history.length===0) return;
  const prev = history.pop();
  circuit = prev.circuit; currentMap = prev.currentMap;
  renderGateList(); renderCircuitVisualization();
  restoreFishPositions(prev.fish);
  steps = Math.max(0, steps-1); stepDisplay.textContent = `æ­¥æ•¸ï¼š${steps}`;
  updateUndoButton();
}
function updateUndoButton(){ undoBtn.disabled = history.length === 0; }

/* é›»è·¯è¦–è¦ºåŒ– */
function renderCircuitVisualization(){
  const c = document.getElementById("circuitVisualization"); c.innerHTML = "";
  for(let i=0; i<bitCount; i++){
    const line = document.createElement("div"); line.className="circuit-line";
    line.innerHTML = `<div class="circuit-line-label">q${i}</div><div class="circuit-line-path" id="circuit-line-${i}"></div>`;
    c.appendChild(line);
  }
  const GRID = 25;
  circuit.forEach((gate,idx)=>{
    const pos = GRID*(idx+1);
    if(gate.type==="X") addXGate(gate.target, pos);
    else if(gate.type==="CNOT") addCNOTGate(gate.control, gate.target, pos, false);
    else if(gate.type==="0CNOT") addCNOTGate(gate.control, gate.target, pos, true);
    else if(gate.type==="CCNOT") addCCNOTGate(gate, pos);
  });
}

function addXGate(t,p){ const l=document.getElementById(`circuit-line-${t}`); const g=document.createElement("div"); g.className="circuit-gate"; g.textContent="X"; g.style.left=p+"px"; l.appendChild(g); }

/* === æ–°çš„é€£ç·šå‡½å¼ === */
function addCNOTGate(c, t, p, hollow) {
    // æ¯ä¸€è¡Œé«˜åº¦ 25px + gap 8px = 33px
    const ROW_H = 33;
    const min = Math.min(c, t);
    const max = Math.max(c, t);
   
    // è¨ˆç®—é€£æ¥ç·šçš„é«˜åº¦èˆ‡ä½ç½®
    // 12.5 æ˜¯è¡Œé«˜çš„ä¸€åŠï¼Œç¢ºä¿ç·šæ¢å¾åœ“å¿ƒé–‹å§‹
    const topPos = (min * ROW_H) + 12.5;
    const height = (max - min) * ROW_H;

    // ç•«å‚ç›´é€£æ¥ç·š
    const container = document.getElementById("circuitVisualization");
    const conn = document.createElement("div");
    conn.className = "circuit-connector";
    conn.style.left = (46 + p) + "px"; // 46 æ˜¯å·¦é‚Š Label çš„åç§»é‡
    conn.style.top = (topPos+5) + "px";
    conn.style.height = (height-10) + "px";
    conn.style.transform = "none"; // é‡è¦ï¼šå–æ¶ˆ CSS çš„ç½®ä¸­åç§»
    container.appendChild(conn);

    // ç•«æ§åˆ¶é» (åœ“é»)
    const cl = document.getElementById(`circuit-line-${c}`);
    const cd = document.createElement("div");
    cd.className = hollow ? "circuit-control hollow" : "circuit-control";
    cd.style.left = p + "px";
    cl.appendChild(cd);

    // ç•«ç›®æ¨™é» (âŠ•)
    const tl = document.getElementById(`circuit-line-${t}`);
    const td = document.createElement("div");
    td.className = "circuit-target";
    td.style.left = (p - 2.2) + "px";
    tl.appendChild(td);
}

function addCCNOTGate(g, p) {
    // æ¯ä¸€è¡Œé«˜åº¦ 25px + gap 8px = 33px
    const ROW_H = 33;
    const lines = [g.control1, g.control2, g.target].sort((a, b) => a - b);
    const min = lines[0];
    const max = lines[2]; // å–æœ€å¤§å’Œæœ€å°çš„è¡Œè™Ÿ

    const topPos = (min * ROW_H) + 12.5;
    const height = (max - min) * ROW_H;

    // ç•«å‚ç›´é€£æ¥ç·š (è²«ç©¿é€™ä¸‰é»)
    const container = document.getElementById("circuitVisualization");
    const conn = document.createElement("div");
    conn.className = "circuit-connector";
    conn.style.left = (46 + p) + "px";
    conn.style.top = (topPos+5) + "px";
    conn.style.height = (height-10) + "px";
    conn.style.transform = "none"; // é‡è¦ï¼šå–æ¶ˆ CSS çš„ç½®ä¸­åç§»
    container.appendChild(conn);

    // ç•«æ§åˆ¶é» 1
    const c1l = document.getElementById(`circuit-line-${g.control1}`);
    const c1d = document.createElement("div");
    c1d.className = g.c1Val === 0 ? "circuit-control hollow" : "circuit-control";
    c1d.style.left = p + "px";
    c1l.appendChild(c1d);

    // ç•«æ§åˆ¶é» 2
    const c2l = document.getElementById(`circuit-line-${g.control2}`);
    const c2d = document.createElement("div");
    c2d.className = g.c2Val === 0 ? "circuit-control hollow" : "circuit-control";
    c2d.style.left = p + "px";
    c2l.appendChild(c2d);

    // ç•«ç›®æ¨™é» (âŠ•)
    const tl = document.getElementById(`circuit-line-${g.target}`);
    const td = document.createElement("div");
    td.className = "circuit-target";
    td.style.left = (p - 2.2) + "px";
    tl.appendChild(td);
}

/* æ ¸å¿ƒï¼šå¥—ç”¨é–˜é–€ + é­šå‹•ç•« */
function applyGateAndAnimate(gate){
  saveStateToHistory();
  addGateToList(gate);
  const size = 1 << bitCount;
  currentMap = Array.from({length:size}, (_,i)=>applyGateToIndex(i, gate));
  const perm = Array.from({length:size}, (_,i)=>applyGateToIndex(i, gate));
  perm.forEach((to,from)=>{
    const pidFrom = (bitCount===3 ? ["planet0","planet1","planet2","planet3","planet4","planet5","planet6","planet7"] : ["planet1","planet2","planet3","planet4"])[from];
    const pidTo   = (bitCount===3 ? ["planet0","planet1","planet2","planet3","planet4","planet5","planet6","planet7"] : ["planet1","planet2","planet3","planet4"])[to];
    const fish = planets[pidFrom]?.querySelector(".person"); if(!fish) return;
    const r1 = planets[pidFrom].getBoundingClientRect();
    const r2 = planets[pidTo].getBoundingClientRect();
    const dx = r2.left - r1.left, dy = r2.top - r1.top;
    fish.style.transform = `translate(${dx}px,${dy}px) translate(-50%,-50%)`;
    setTimeout(()=>{ planets[pidTo].appendChild(fish); fish.style.transform="translate(-50%,-50%)"; checkSuccess(); },800);
  });
  steps++; stepDisplay.textContent = `æ­¥æ•¸ï¼š${steps}`;
  updateUndoButton();
}

function getCurrentLevel(){ return bitLevels[bitCount][currentLevel]; }

function loadLevel(idx){
  document.getElementById("levelNumber").textContent = `é¡Œç›®ï¼š${idx+1}`;
  container.querySelectorAll(".planet").forEach(p=>p.remove());
  svg.innerHTML=""; planets = {};
  const level = getCurrentLevel();
  const is3bit = bitCount===3;
  const planetSize = is3bit ? 90 : 140;
  
  container.style.width = container.style.height = is3bit ? "600px" : "420px";

  level.planets.forEach(p=>{
    const div = document.createElement("div");
    div.className = "planet"; div.id = p.id;
    div.style.top = p.top+"px"; div.style.left = p.left+"px";
    div.style.width = div.style.height = planetSize+"px";
    if(is3bit) div.setAttribute("data-label", p.label);
    const img = document.createElement("img");
    img.src = is3bit ? planetImg3[p.key] : planetImg[p.key];
    div.appendChild(img);
    container.appendChild(div);
    planets[p.id] = div;
  });

  const offset = is3bit ? 45 : 70;

  level.lines.forEach(([id,p1,p2])=>{
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    const pl1 = level.planets.find(x=>x.id===p1);
    const pl2 = level.planets.find(x=>x.id===p2);
    line.setAttribute("x1",pl1.left+offset); line.setAttribute("y1",pl1.top+offset);
    line.setAttribute("x2",pl2.left+offset); line.setAttribute("y2",pl2.top+offset);
    line.style.stroke = "#555"; line.style.strokeWidth = "4";
    svg.appendChild(line);
    line.addEventListener("mouseenter",()=>{line.style.stroke="#ffcc00"; line.style.strokeWidth="8";});
    line.addEventListener("mouseleave",()=>{line.style.stroke="#555"; line.style.strokeWidth="4";});
    line.addEventListener("click",()=>onLineClick(p1,p2));
  });

  princes = JSON.parse(JSON.stringify(level.princes));
  placePrincesByFixedArrangement(idx);
  steps = 0; stepDisplay.textContent = "æ­¥æ•¸ï¼š0";
  startTimer(); renderCircuitVisualization(); history = []; updateUndoButton();
}

function placePrincesByFixedArrangement(idx){
  Object.values(planets).forEach(p => p.querySelectorAll(".person").forEach(img => img.remove()));
  if(bitCount===3){
    const perm = permList3bit[idx];
    const order = ["3flowerFish","BobFish","KuroverFish","SiamFish","BlackFish","BinsFish","SakabanFish","WhiteFish"];
    const ids = ["planet0","planet1","planet2","planet3","planet4","planet5","planet6","planet7"];
    perm.forEach((fishIdx,pos)=>{
      const img = document.createElement("img");
      img.src = fishImg3[order[fishIdx]];
      img.className = "person";
      planets[ids[pos]].appendChild(img);
    });
  } else if(bitCount===1){
    const ids = ["planet1","planet2"];
    const fishList = [fishImg["3flowerFish"], fishImg["BobFish"]];
    fishList.forEach((src, i) => {
        const img = document.createElement("img");
        img.src = src;
        img.className = "person";
        planets[ids[i]].appendChild(img);
    });
  } else {
    const perm = permList[idx];
    const fishOrder = [fishImg["3flowerFish"], fishImg["BobFish"], fishImg["KuroFish"], fishImg["dollFish"]];
    const ids = ["planet1","planet2","planet3","planet4"];
    perm.forEach((fishIdx,pos)=>{
      const img = document.createElement("img");
      img.src = fishOrder[fishIdx];
      img.className = "person";
      planets[ids[pos]].appendChild(img);
    });
  }
}

function checkSuccess(){
  const ok = princes.every(p=>{
    const img = planets[p.target].querySelector(".person");
    return img && img.src === p.img;
  });
  if(ok){ clearInterval(timerInterval); showPopup(steps, Math.floor((Date.now()-startTime)/1000)); }
}

function startTimer(){
  clearInterval(timerInterval);
  startTime = Date.now();
  timerInterval = setInterval(()=>{ timerDisplay.textContent = `æ™‚é–“ï¼š${Math.floor((Date.now()-startTime)/1000)} ç§’`; },1000);
}
function showPopup(s,t){ document.querySelector("#successPopup p").innerHTML = `å“‡ï¼ä½ èµ°äº† ${s} æ­¥ï¼ŒèŠ±äº† ${t} ç§’ï¼Œè®“æ¯éš»è²“éƒ½åƒåˆ°å°æ‡‰çš„é­šè€¶~`; document.getElementById("successPopup").style.display = "flex"; }
function softResetFish(){ steps=0; stepDisplay.textContent="æ­¥æ•¸ï¼š0"; placePrincesByFixedArrangement(currentLevel); startTimer(); history=[]; updateUndoButton(); }

function onLineClick(p1, p2) {
  const key = [p1, p2].sort().join(",");

  if (bitCount === 1) {
    applyGateAndAnimate({ type: "X", target: 0 });
    return;
  }

  if (bitCount === 2) {
    const map2 = {
      "planet1,planet2": { type: "0CNOT", control: 0, target: 1 },
      "planet1,planet3": { type: "0CNOT", control: 1, target: 0 },
      "planet2,planet4": { type: "CNOT",  control: 1, target: 0 },
      "planet3,planet4": { type: "CNOT",  control: 0, target: 1 }
    };
    if (map2[key]) applyGateAndAnimate(map2[key]);
    return;
  }

  if (bitCount === 3) {
    const map3 = {
      // q0 (LSB) æ”¹è®Š
      "planet0,planet1": { type: "CCNOT", control1: 0, c1Val: 0, control2: 1, c2Val: 0, target: 2 },
      "planet2,planet3": { type: "CCNOT", control1: 0, c1Val: 0, control2: 1, c2Val: 1, target: 2 },
      "planet4,planet5": { type: "CCNOT", control1: 0, c1Val: 1, control2: 1, c2Val: 0, target: 2 },
      "planet6,planet7": { type: "CCNOT", control1: 0, c1Val: 1, control2: 1, c2Val: 1, target: 2 },

      // q1 (Middle) æ”¹è®Š
      "planet0,planet2": { type: "CCNOT", control1: 0, c1Val: 0, control2: 2, c2Val: 0, target: 1 },
      "planet1,planet3": { type: "CCNOT", control1: 0, c1Val: 0, control2: 2, c2Val: 1, target: 1 },
      "planet4,planet6": { type: "CCNOT", control1: 0, c1Val: 1, control2: 2, c2Val: 0, target: 1 },
      "planet5,planet7": { type: "CCNOT", control1: 0, c1Val: 1, control2: 2, c2Val: 1, target: 1 },

      // q2 (MSB) æ”¹è®Š
      "planet0,planet4": { type: "CCNOT", control1: 1, c1Val: 0, control2: 2, c2Val: 0, target: 0 },
      "planet1,planet5": { type: "CCNOT", control1: 1, c1Val: 0, control2: 2, c2Val: 1, target: 0 },
      "planet2,planet6": { type: "CCNOT", control1: 1, c1Val: 1, control2: 2, c2Val: 0, target: 0 },
      "planet3,planet7": { type: "CCNOT", control1: 1, c1Val: 1, control2: 2, c2Val: 1, target: 0 }
    };

    if (map3[key]) applyGateAndAnimate(map3[key]);
    return;
  }
}

document.getElementById("closePopup").onclick = ()=>{ document.getElementById("successPopup").style.display="none"; resetCircuit(); };
document.getElementById("resetBtn").onclick = ()=>{ resetCircuit(); };
document.getElementById("bitSelector").onchange = (e)=>{
  bitCount = parseInt(e.target.value);
  currentLevel = 0;
  circuit = []; 
  renderGateButtons();
  loadLevel(currentLevel);
  resetCircuit(); 
};
let animating=false;
function transitionLevel(next,dir){
  if(animating) return; animating=true;
  container.classList.add(dir==="left"?"slide-out-left":"slide-out-right");
  setTimeout(()=>{
    currentLevel = next;
    loadLevel(currentLevel);
    container.classList.remove("slide-out-left","slide-out-right");
    container.classList.add(dir==="left"?"slide-in-right":"slide-in-left");
    setTimeout(()=>{ container.classList.remove("slide-in-right","slide-in-left"); animating=false; },620);
  },320);
}
document.getElementById("prevBtn").onclick = ()=>{ const L=bitLevels[bitCount].length; transitionLevel((currentLevel-1+L)%L,"left"); resetCircuit(); };
document.getElementById("nextBtn").onclick = ()=>{ const L=bitLevels[bitCount].length; transitionLevel((currentLevel+1)%L,"right"); resetCircuit(); };

const toggleBtn = document.getElementById('toggleCircuitBtn');
let hidden = false;
toggleBtn.addEventListener('click', ()=>{ hidden=!hidden; document.body.classList.toggle('hide-circuit-mode',hidden); });
document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='h') toggleBtn.click(); });

renderGateButtons();
loadLevel(currentLevel);
</script>
</body>
</html>
