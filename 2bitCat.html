<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ë≤ìË≤ìÊòüÁêÉ</title>
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 40px;
        height: 100vh;
        background: #d6cc98;
        font-family: sans-serif;
        overflow: hidden;
        transition: all 0.4s ease;
    }
    body {
        margin: 0;
        overflow: hidden;
        background-image: url("https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=2000&q=80");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    #gameWrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 500px;
    }
    #container {
        position: relative;
        width: 420px;
        height: 420px;
        overflow: visible;
        margin: 0 auto;
    }
    .planet {
        position: absolute;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,.2);
    }
    .planet img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    line {
        stroke: #555;
        stroke-width: 5;
        cursor: pointer;
        transition: stroke .3s;
    }
    line:hover {
        stroke: #000;
    }
    .person {
        width: 90px;
        height: 90px;
        object-fit: contain;
        pointer-events: none;
        transition: transform .8s ease;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
    }
   
    /* Â∑¶ÂÅ¥Êï¥ÂêàÈù¢Êùø */
    .left-panel {
        position: absolute;
        left: 10px;
        top: 50px;
        width: 220px;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        font-size: 14px;
        color: #1e293b;
        z-index: 100;
        max-height: 85vh;
        overflow-y: auto;
        transition: all 0.4s ease;
    }
   
    .left-panel h3 {
        margin: 0 0 10px;
        font-size: 15px;
        color: #1e293b;
        text-align: center;
    }
   
    #info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
    }
   
    #levelNumber {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }
   
    #steps {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
    }
   
    #timer {
        font-size: 1rem;
        color: #444;
    }
   
    #buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        width: 100%;
    }
    #resetBtn {
        padding: 8px 16px;
        background: #7a654f;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
    }
    #resetBtn:hover {
        background: #5c4d3a;
    }
    #prevBtn, #nextBtn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: #f1f1f1b1;
        color: #7a654f;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background .3s;
    }
    #prevBtn:hover, #nextBtn:hover {
        background: #5c4d3a;
        color: #fff;
    }
    #prevBtn::before, #nextBtn::before {
        content: "";
        display: block;
        width: 0;
        height: 0;
        border: 12px solid transparent;
        position: absolute;
    }
    #prevBtn::before {
        border-right-color: #7a654f;
        margin-left: -5px;
    }
    #nextBtn::before {
        border-left-color: #7a654f;
        margin-left: 5px;
    }
    #prevBtn:hover::before {
        border-right-color: #fff;
    }
    #nextBtn:hover::before {
        border-left-color: #fff;
    }
    @media (max-width: 768px) {
        #container {
            width: 380px;
            height: 380px;
        }
        .planet {
            width: 120px;
            height: 120px;
        }
        .person {
            width: 80px;
            height: 80px;
        }
    }
    .slide-out-left {
        animation: slideOutLeft .6s forwards;
    }
    .slide-in-right {
        animation: slideInRight .6s forwards;
    }
    .slide-out-right {
        animation: slideOutRight .6s forwards;
    }
    .slide-in-left {
        animation: slideInLeft .6s forwards;
    }
    @keyframes slideOutLeft {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(-100%); opacity: 0; }
    }
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    .popup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn .3s ease;
    }
    .popup-content {
        background: #fff;
        border-radius: 20px;
        padding: 30px 40px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,.3);
        animation: popUp .4s ease;
        max-width: 90%;
    }
    .popup-content h2 {
        margin: 8px 0 10px;
    }
    .popup-content button {
        background: #ffb60b;
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        transition: background .2s;
    }
    .popup-content button:hover {
        background: #ff750b;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes popUp {
        from { transform: scale(.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .gate-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }
    .gate-btns {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
    }
    .gate-btn {
        flex: 1 1 45%;
        padding: 6px 8px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,.08);
        text-align: center;
    }
    .gate-btn:hover {
        background: #f8fafc;
        box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }
    .gate-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: 8px 0;
        max-height: 80px;
        overflow-y: auto;
    }
    .gate-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 3px 7px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-family: ui-monospace, monospace;
        font-size: 11px;
        box-shadow: 0 1px 2px rgba(0,0,0,.06);
    }
    .gate-badge .remove {
        width: 15px;
        height: 15px;
        background: #ef4444;
        color: #fff;
        border: none;
        border-radius: 50%;
        font-size: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .gate-badge .remove:hover {
        background: #dc2626;
    }
    .reset-circuit-btn {
        width: 100%;
        margin-top: 8px;
        padding: 6px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 12px;
        cursor: pointer;
    }
    .reset-circuit-btn:hover {
        background: #f8fafc;
    }
    
    /* ‰∏ä‰∏ÄÊ≠•ÊåâÈàï */
    #undoBtn {
        padding: 8px 16px;
        background: #7a654f;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
    }
    #undoBtn:hover {
        background: #5c4d3a;
    }
    #undoBtn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    
    /* Â∫ïÈÉ®ÈõªË∑ØÂúñÈù¢Êùø */
    .circuit-panel {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        max-width: 3000px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        font-size: 14px;
        color: #1e293b;
        z-index: 100;
        transition: all 0.4s ease;
    }
    .circuit-panel h3 {
        margin: 0 0 10px;
        font-size: 15px;
        color: #1e293b;
        text-align: center;
    }
    .circuit-visualization {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
    }
    .circuit-line {
        display: flex;
        align-items: center;
        height: 25px;
    }
    .circuit-line-label {
        width: 30px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
    }
    .circuit-line-path {
        flex: 1;
        height: 2px;
        background: #111111;
        position: relative;
        margin: 0 10px;
    }
    .circuit-gate {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background: #7a654f;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: bold;
    }
    .circuit-control {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #111111;
        border: 2px solid #000000;
    }
    .circuit-control.hollow {
        background: white !important;
        border: 2px solid #000000 !important;
    }
    .circuit-target {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border-radius: 50%;
        color: #111111;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
    }
    .circuit-target::after {
        content: "‚äï";
    }
    .circuit-connector {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 2px;
        height: 100%;
        background: #111111;
    }

    /* ==================== Êñ∞Â¢ûÔºöÈö±ËóèÈõªË∑ØÊ®°Âºè ==================== */
    .hide-circuit-mode .left-panel,
    .hide-circuit-mode .circuit-panel {
        transform: translateX(-120%) !important;
        opacity: 0;
        pointer-events: none;
    }
    .hide-circuit-mode .circuit-panel {
        transform: translateY(120%) !important;
    }
    .toggle-circuit-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: rgba(122, 101, 79, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .toggle-circuit-btn:hover {
        background: #5c4d3a;
        transform: scale(1.1);
    }
    .toggle-circuit-btn::before {
        content: "‚ö°";
    }
    .hide-circuit-mode .toggle-circuit-btn::before {
        content: "üëÅÔ∏è";
    }
</style>
</head>
<body>
<div id="gameWrapper">
  <h2 style="margin:10px 0 5px;">Ë≤ìË≤ìÊòüÁêÉ</h2>
  <div id="container"><svg></svg></div>
  <div id="buttons">
    <button id="prevBtn"></button>
    <button id="resetBtn">ÈáçÊñ∞ÈñãÂßã</button>
    <button id="nextBtn"></button>
  </div>
</div>

<!-- Â∑¶ÂÅ¥Êï¥ÂêàÈù¢Êùø -->
<div class="left-panel">
  <h3>ÈÅäÊà≤Ë≥áË®ä</h3>
  <div id="info">
    <div id="levelNumber">È°åÁõÆÔºö1</div>
    <div id="steps">Ê≠•Êï∏Ôºö0</div>
    <div id="timer">ÊôÇÈñìÔºö0 Áßí</div>
  </div>

  <div class="gate-section">
    <h3>ÈÅ∏Êìá BIT Êï∏</h3>
    <select id="bitSelector">
      <option value="1">1 BIT</option>
      <option value="2" selected>2 BIT</option>
    </select>
    <h3 style="margin-top:10px;">Êñ∞Â¢ûÈáèÂ≠êÈñòÈñÄ</h3>
    <div class="gate-btns">
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'X', target:0})">X q0</button>
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'X', target:1})">X q1</button>
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'CNOT', control:0, target:1})">1CNOT q0‚Üíq1</button>
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'CNOT', control:1, target:0})">1CNOT q1‚Üíq0</button>
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'0CNOT q0‚Üíq1'})">0CNOT q0‚Üíq1</button>
      <button class="gate-btn" onclick="applyGateAndAnimate({type:'0CNOT q1‚Üíq0'})">0CNOT q1‚Üíq0</button>
    </div>
    <h3 style="margin-top:10px;">ÁõÆÂâçÈõªË∑Ø</h3>
    <div id="gateList" class="gate-list"></div>
    <button class="reset-circuit-btn" onclick="resetCircuit()">ÈáçË®≠ÈõªË∑Ø</button>
    
    <!-- ‰∏ä‰∏ÄÊ≠•ÊåâÈàï -->
    <button id="undoBtn" onclick="undoLastStep()" disabled>ÂõûÂà∞‰∏ä‰∏ÄÊ≠•</button>
  </div>
</div>

<!-- Â∫ïÈÉ®ÈõªË∑ØÂúñÈù¢Êùø -->
<div class="circuit-panel">
  <h3>ÈõªË∑ØÂúñ</h3>
  <div id="circuitVisualization" class="circuit-visualization">
    <!-- ÈõªË∑ØÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÁîüÊàê -->
  </div>
</div>

<!-- ÊàêÂäüÂΩàÁ™ó -->
<div id="successPopup" class="popup">
  <div class="popup-content">
    <h2>Congratulations ÊàêÂäüÔºÅ</h2>
    <p></p><br>
    <button id="closePopup">ÂÜçÁé©‰∏ÄÊ¨°</button>
  </div>
</div>

<!-- Êñ∞Â¢ûÔºöÈö±ËóèÈõªË∑ØÊåâÈàïÔºàÂè≥‰∏äËßíÔºâ -->
<button class="toggle-circuit-btn" id="toggleCircuitBtn" title="ÂàáÊèõÈö±ËóèÈõªË∑ØÊ®°ÂºèÔºàÊàñÊåâ H ÈçµÔºâ"></button>

<script>
  /* ---------- ÂúñÁâá ---------- */
  const raw = "https://raw.githubusercontent.com/s112321005/little_prince/main/";
  const planetImg = {
    "3flower": raw+"3flower_00.png",
    "Bob":     raw+"Bob_01.png",
    "Kurover": raw+"Kurover_10.png",
    "doll":    raw+"doll_11.png"
  };
  const fishImg = {
    "3flowerFish": raw+"3flowerFish.png",
    "BobFish":     raw+"BobFish.png",
    "KuroFish":    raw+"KuroFish.png",
    "dollFish":    raw+"dollFish%20.png"
  };
  /* ---------- 24 ÂÄãÊéíÂàóÔºà0=00,1=01,2=10,3=11Ôºâ---------- */
  const permList = [
   "0132","0213","0231","0312","0321",
    "1023","1032","1203","1230","1302","1320",
    "2013","2031","2103","2130","2301","2310",
    "3012","3021","3102","3120","3201","3210"
  ].map(s => s.split("").map(Number));
  /* ---------- ÈóúÂç°Ë≥áÊñôÔºà2-bit ÂÖ±Êúâ 24 È°åÔºåË°åÊòüÂõ∫ÂÆöÔºâ ---------- */
  let bitCount = 2;
  const bitLevels = {
    1: [{
      planets: [
        {id:"planet1", key:"3flower", top:140, left:20},
        {id:"planet2", key:"Bob",     top:140, left:260}
      ],
      princes: [
        {img: fishImg["3flowerFish"], target:"planet1"},
        {img: fishImg["BobFish"],     target:"planet2"}
      ],
      lines:[["line12","planet1","planet2"]]
    }],
    2: Array.from({length: permList.length}, () => ({
      planets: [
        {id:"planet1", key:"3flower", top:0,   left:0},
        {id:"planet2", key:"Bob",     top:0,   left:280},
        {id:"planet3", key:"Kurover", top:280, left:0},
        {id:"planet4", key:"doll",    top:280, left:280}
      ],
      princes: [
        {img: fishImg["3flowerFish"], target:"planet1"},
        {img: fishImg["BobFish"],     target:"planet2"},
        {img: fishImg["KuroFish"],    target:"planet3"},
        {img: fishImg["dollFish"],    target:"planet4"}
      ],
      lines: [
        ["line12","planet1","planet2"],
        ["line13","planet1","planet3"],
        ["line24","planet2","planet4"],
        ["line34","planet3","planet4"]
      ]
    }))
  };
  /* ---------- 2-bitÔºöÁ¥¢ÂºïÂ∞çÊáâÔºàÂõ∫ÂÆö‰∏çÂãïÁöÑË°åÊòüÔºâ ---------- */
  const indexToPlanetId = ["planet1","planet2","planet3","planet4"];
  /* ---------- ÁãÄÊÖãËÆäÊï∏ ---------- */
  let currentLevel = 0, steps = 0, startTime, timerInterval;
  let circuit = [], currentMap = [0,1,2,3];
  let planets = {}, princes = [];
  const stepDisplay = document.getElementById("steps");
  const timerDisplay = document.getElementById("timer");
  const container = document.getElementById("container");
  const svg = container.querySelector("svg");
  
  /* ---------- Êñ∞Â¢ûÔºöÊ≠∑Âè≤Ë®òÈåÑ ---------- */
  let history = [];
  const undoBtn = document.getElementById("undoBtn");
  /* ---------- ‰ΩçÂÖÉÂ∑•ÂÖ∑ ---------- */
  function stateIndexToBits(i){ return i.toString(2).padStart(bitCount,"0").split("").map(Number); }
  function bitsToStateIndex(bits){ return parseInt(bits.join(""),2); }
  /* ---------- Gate ÊáâÁî®Ôºà‰ΩúÁî®Âú®ÁãÄÊÖãÁ¥¢ÂºïÔºâ ---------- */
  function applyGateToIndex(stateIndex, gate){
    const b = stateIndexToBits(stateIndex);
    const nb = b.slice();
    switch(gate.type){
      case "X":
        nb[gate.target] ^= 1; break;
      case "CNOT":
        if(nb[gate.control]) nb[gate.target] ^= 1; break;
      case "0CNOT q0‚Üíq1":
        if(nb[0] === 0) nb[1] ^= 1; break;
      case "0CNOT q1‚Üíq0":
        if(nb[1] === 0) nb[0] ^= 1; break;
    }
    return bitsToStateIndex(nb);
  }
  /* ---------- Gate Ê∏ÖÂñÆ ---------- */
  function addGateToList(g){
    circuit.push(g);
    renderGateList();
    renderCircuitVisualization();
  }

  function resetCircuit(){
    saveStateToHistory();
    circuit = [];
    currentMap = [0,1,2,3];
    renderGateList();
    renderCircuitVisualization();
    softResetFish();
    updateUndoButton();
  }

  function renderGateList(){
    const box = document.getElementById("gateList"); box.innerHTML = "";
    circuit.forEach((g,idx)=>{
      const el = document.createElement("div"); el.className = "gate-badge";
      el.innerHTML = `<span>${
        g.type==="X" ? `X q${g.target}` :
        g.type==="CNOT" ? `1CNOT q${g.control}‚Üíq${g.target}` : g.type
      }</span>`;
      const x = document.createElement("button"); x.className="remove"; x.textContent="x";
      x.onclick = ()=>{ 
        saveStateToHistory();
        circuit.splice(idx,1); 
        renderGateList(); 
        renderCircuitVisualization(); 
        updateUndoButton();
      };
      el.appendChild(x); box.appendChild(el);
    });
  }
  /* ---------- Ê≠∑Âè≤Ë®òÈåÑÁõ∏Èóú ---------- */
  function saveStateToHistory() {
    const currentState = {
      circuit: JSON.parse(JSON.stringify(circuit)),
      currentMap: [...currentMap],
      fishPositions: getCurrentFishPositions()
    };
    history.push(currentState);
    if (history.length > 50) history.shift();
    updateUndoButton();
  }
  function getCurrentFishPositions() {
    const positions = {};
    Object.keys(planets).forEach(planetId => {
      const fish = planets[planetId].querySelector(".person");
      if (fish) positions[planetId] = fish.src;
    });
    return positions;
  }
  function restoreFishPositions(positions) {
    Object.values(planets).forEach(p => {
      p.querySelectorAll(".person").forEach(img => img.remove());
    });
    Object.keys(positions).forEach(planetId => {
      if (planets[planetId]) {
        const img = document.createElement("img");
        img.src = positions[planetId];
        img.alt = "fish";
        img.className = "person";
        planets[planetId].appendChild(img);
      }
    });
  }
  function undoLastStep() {
    if (history.length === 0) return;
    const previousState = history.pop();
    circuit = previousState.circuit;
    currentMap = previousState.currentMap;
    renderGateList();
    renderCircuitVisualization();
    restoreFishPositions(previousState.fishPositions);
    steps = Math.max(0, steps - 1);
    stepDisplay.textContent = `Ê≠•Êï∏Ôºö${steps}`;
    updateUndoButton();
  }
  function updateUndoButton() {
    undoBtn.disabled = history.length === 0;
  }
  /* ---------- ÈõªË∑ØË¶ñË¶∫Âåñ ---------- */
  function renderCircuitVisualization() {
    const container = document.getElementById("circuitVisualization");
    container.innerHTML = "";
    for (let i = 0; i < bitCount; i++) {
        const lineDiv = document.createElement("div");
        lineDiv.className = "circuit-line";
        const labelDiv = document.createElement("div");
        labelDiv.className = "circuit-line-label";
        labelDiv.textContent = `q${i}`;
        const pathDiv = document.createElement("div");
        pathDiv.className = "circuit-line-path";
        pathDiv.id = `circuit-line-${i}`;
        lineDiv.appendChild(labelDiv);
        lineDiv.appendChild(pathDiv);
        container.appendChild(lineDiv);
    }
    const GRID_SIZE = 25;
    circuit.forEach((gate, index) => {
        const gatePosition = GRID_SIZE * (index + 1);
        switch(gate.type) {
            case "X":
                addXGate(gate.target, gatePosition);
                break;
            case "CNOT":
                addCNOTGate(gate.control, gate.target, gatePosition, false);
                break;
            case "0CNOT q0‚Üíq1":
                addCNOTGate(0, 1, gatePosition, true);
                break;
            case "0CNOT q1‚Üíq0":
                addCNOTGate(1, 0, gatePosition, true);
                break;
        }
    });
  }

  function addXGate(target, position) {
    const line = document.getElementById(`circuit-line-${target}`);
    const gate = document.createElement("div");
    gate.className = "circuit-gate";
    gate.textContent = "X";
    gate.style.left = `${position}px`;
    line.appendChild(gate);
  }

  function addCNOTGate(control, target, position, isHollow) {
    const lineHeight = Math.abs(target - control) * 22;
    const minLine = Math.min(control, target);
    const controlLine = document.getElementById(`circuit-line-${control}`);
    const controlDot = document.createElement("div");
    controlDot.className = isHollow ? "circuit-control hollow" : "circuit-control";
    controlDot.style.left = `${position}px`;
    controlLine.appendChild(controlDot);
    const targetLine = document.getElementById(`circuit-line-${target}`);
    const targetDot = document.createElement("div");
    targetDot.className = "circuit-target";
    targetDot.style.left = `${position-2.2}px`;
    targetLine.appendChild(targetDot);
    const connector = document.createElement("div");
    connector.className = "circuit-connector";
    connector.style.left = `${60 + position}px`;
    connector.style.top = `${64 +10+ minLine * 25}px`;
    connector.style.height = `${lineHeight}px`;
    document.getElementById("circuitVisualization").appendChild(connector);
  }

  /* ---------- Èªû Gate ‚Üí ÂãïÁï´Êê¨È≠ö ---------- */
  function applyGateAndAnimate(gate){
    saveStateToHistory();
    addGateToList(gate);
    currentMap = currentMap.map(x => applyGateToIndex(x, gate));
    const perm = [0,1,2,3].map(i => applyGateToIndex(i, gate));
    perm.forEach((toIdx,fromIdx)=>{
      const planetList = getCurrentLevel().planets;
      if(fromIdx>=planetList.length || toIdx>=planetList.length) return;
      const pidFrom = indexToPlanetId[fromIdx];
      const pidTo   = indexToPlanetId[toIdx];
      const fish = planets[pidFrom].querySelector(".person"); if(!fish) return;
      const r1 = planets[pidFrom].getBoundingClientRect();
      const r2 = planets[pidTo].getBoundingClientRect();
      const dx = r2.left - r1.left, dy = r2.top - r1.top;
      fish.style.transform = `translate(${dx}px,${dy}px) translate(-50%,-50%)`;
      setTimeout(()=>{
        planets[pidTo].appendChild(fish);
        fish.style.transform="translate(-50%,-50%)";
        checkSuccess();
      },800);
    });
    steps++; stepDisplay.textContent = `Ê≠•Êï∏Ôºö${steps}`;
    updateUndoButton();
  }
  function getCurrentLevel(){ return bitLevels[bitCount][currentLevel]; }
  /* ---------- ËºâÂÖ•ÈóúÂç° ---------- */
  function loadLevel(idx){
    document.getElementById("levelNumber").textContent = `È°åÁõÆÔºö${idx+1}`;
    container.querySelectorAll(".planet").forEach(p=>p.remove());
    svg.innerHTML=""; planets = {};
    const level = getCurrentLevel();
    level.planets.forEach(p=>{
      const div = document.createElement("div");
      div.className = "planet"; div.id = p.id;
      div.style.top = p.top+"px"; div.style.left = p.left+"px";
      const img = document.createElement("img"); img.src = planetImg[p.key];
      div.appendChild(img);
      container.appendChild(div);
      planets[p.id] = div;
    });
    level.lines.forEach(([id,p1,p2])=>{
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      const pl1 = level.planets.find(x=>x.id===p1);
      const pl2 = level.planets.find(x=>x.id===p2);
      line.setAttribute("x1",pl1.left+70); line.setAttribute("y1",pl1.top+70);
      line.setAttribute("x2",pl2.left+70); line.setAttribute("y2",pl2.top+70);
      line.style.stroke="#555"; line.style.strokeWidth=4; line.style.cursor="pointer";
      svg.appendChild(line);
      line.addEventListener("mouseenter",()=>{line.style.stroke="#ffcc00"; line.style.strokeWidth=8;});
      line.addEventListener("mouseleave",()=>{line.style.stroke="#555"; line.style.strokeWidth=4;});
      line.addEventListener("click",()=>onLineClick(p1,p2));
    });
    princes = JSON.parse(JSON.stringify(level.princes));
    placePrincesByFixedArrangement(idx);
    steps = 0; stepDisplay.textContent = "Ê≠•Êï∏Ôºö0";
    startTimer();
    renderCircuitVisualization();
    history = [];
    updateUndoButton();
  }
  /* ---------- ‰æù 24 ÊéíÂàóÊîæÈ≠ö ---------- */
  function placePrincesByFixedArrangement(levelIdx){
    const keys = indexToPlanetId;
    Object.values(planets).forEach(p =>
      p.querySelectorAll(".person").forEach(img => img.remove())
    );
    if (bitCount === 1) {
      princes.forEach((prince, i) => {
        const img = document.createElement("img");
        img.src = prince.img;
        img.alt = "fish";
        img.className = "person";
        const planetId = i === 0 ? "planet2" : "planet1";
        planets[planetId].appendChild(img);
      });
      return;
    }
    const perm = permList[levelIdx];
    const fishImgs = [
      fishImg["3flowerFish"],
      fishImg["BobFish"],
      fishImg["KuroFish"],
      fishImg["dollFish"]
    ];
    for (let pos = 0; pos < 4; pos++) {
      const fishIndex = perm[pos];
      const img = document.createElement("img");
      img.src = fishImgs[fishIndex];
      img.alt = "fish";
      img.className = "person";
      const planetId = keys[pos];
      planets[planetId].appendChild(img);
    }
  }
  function onLineClick(p1, p2) {
    const mapKey = `${p1},${p2}`;
    const mapKeyRev = `${p2},${p1}`;
    const mapping = {
      "planet1,planet2": { type: "0CNOT q0‚Üíq1", gateObj: { type:"0CNOT q0‚Üíq1" } },
      "planet1,planet3": { type: "0CNOT q1‚Üíq0", gateObj: { type:"0CNOT q1‚Üíq0" } },
      "planet2,planet4": { type: "CNOT", gateObj: { type:"CNOT", control:1, target:0 } },
      "planet3,planet4": { type: "CNOT", gateObj: { type:"CNOT", control:0, target:1 } }
    };
    const entry = mapping[mapKey] || mapping[mapKeyRev];
    if (!entry) return swap(p1,p2);
    if (entry.gateObj && entry.gateObj.type === "CNOT") {
      applyGateAndAnimate({ type: "CNOT", control: entry.gateObj.control, target: entry.gateObj.target });
    } else {
      applyGateAndAnimate({ type: entry.type });
    }
  }
  /* ---------- ÈªûÁ∑ö‰∫íÊèõÂãïÁï´ ---------- */
  function swap(p1,p2){
    saveStateToHistory();
    const a = planets[p1].querySelector(".person");
    const b = planets[p2].querySelector(".person");
    if(!a||!b) return;
    steps++; stepDisplay.textContent = `Ê≠•Êï∏Ôºö${steps}`;
    const r1 = planets[p1].getBoundingClientRect();
    const r2 = planets[p2].getBoundingClientRect();
    const dx = r2.left - r1.left, dy = r2.top - r1.top;
    a.style.transform = `translate(${dx}px,${dy}px) translate(-50%,-50%)`;
    b.style.transform = `translate(${-dx}px,${-dy}px) translate(-50%,-50%)`;
    setTimeout(()=>{
      planets[p1].appendChild(b);
      planets[p2].appendChild(a);
      a.style.transform = b.style.transform = "translate(-50%,-50%)";
      checkSuccess();
      updateUndoButton();
    },800);
  }
  /* ---------- Âà§ÂÆöÈÅéÈóú ---------- */
  function checkSuccess(){
    const ok = princes.every(prince=>{
      const img = planets[prince.target].querySelector(".person");
      return img && img.src === prince.img;
    });
    if(ok){
      clearInterval(timerInterval);
      showPopup(steps, Math.floor((Date.now()-startTime)/1000));
    }
  }
  /* ---------- Ë®àÊôÇÂô® / ÈáçË®≠ ---------- */
  function startTimer(){
    clearInterval(timerInterval);
    startTime = Date.now();
    timerInterval = setInterval(()=>{
      timerDisplay.textContent = `ÊôÇÈñìÔºö${Math.floor((Date.now()-startTime)/1000)} Áßí`;
    },1000);
  }
  function showPopup(steps,sec){
    document.querySelector("#successPopup p").innerHTML =
      `ÂìáÔºÅ‰Ω†Ëµ∞‰∫Ü ${steps} Ê≠•ÔºåËä±‰∫Ü ${sec} ÁßíÔºåËÆìÊØèÈöªË≤ìÈÉΩÂêÉÂà∞Â∞çÊáâÁöÑÈ≠öËÄ∂~`;
    document.getElementById("successPopup").style.display = "flex";
  }
  function softResetFish(){
    steps = 0; stepDisplay.textContent = "Ê≠•Êï∏Ôºö0";
    placePrincesByFixedArrangement(currentLevel);
    startTimer();
    history = [];
    updateUndoButton();
  }
  /* ---------- ‰∫ã‰ª∂Áπ´Áµê ---------- */
  document.getElementById("closePopup").onclick = ()=>{
    document.getElementById("successPopup").style.display = "none";
    resetCircuit();
    softResetFish();
  };
  document.getElementById("resetBtn").onclick = ()=>{ resetCircuit(); };
  document.getElementById("bitSelector").onchange = (e)=>{
    bitCount = parseInt(e.target.value);
    currentLevel = 0;
    loadLevel(currentLevel);
    resetCircuit();
  };
  let animating=false;
  function transitionLevel(nextIdx,dir){
    if(animating) return; animating = true;
    container.classList.add(dir==="left"?"slide-out-left":"slide-out-right");
    setTimeout(()=>{
      currentLevel = nextIdx;
      loadLevel(currentLevel);
      container.classList.remove("slide-out-left","slide-out-right");
      container.classList.add(dir==="left"?"slide-in-right":"slide-in-left");
      setTimeout(()=>{
        container.classList.remove("slide-in-right","slide-in-left");
        animating = false;
      },620);
    },320);
  }
  document.getElementById("prevBtn").onclick = ()=>{
    const L = bitLevels[bitCount].length;
    transitionLevel((currentLevel-1+L)%L,"left");
    resetCircuit();
  };
  document.getElementById("nextBtn").onclick = ()=>{
    const L = bitLevels[bitCount].length;
    transitionLevel((currentLevel+1)%L,"right");
    resetCircuit();
  };

  /* ==================== Êñ∞Â¢ûÔºöÈö±ËóèÈõªË∑ØÂäüËÉΩ ==================== */
  const toggleBtn = document.getElementById('toggleCircuitBtn');
  let circuitHidden = false;

  toggleBtn.addEventListener('click', () => {
    circuitHidden = !circuitHidden;
    if (circuitHidden) {
      document.body.classList.add('hide-circuit-mode');
    } else {
      document.body.classList.remove('hide-circuit-mode');
    }
  });

  // ÊåâÈçµÁõ§ H ÈçµÂø´ÈÄüÂàáÊèõÔºàË∂ÖÂ•ΩÁî®Ôºâ
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'h') {
      toggleBtn.click();
    }
  });

  /* ---------- ÂïüÂãï ---------- */
  loadLevel(currentLevel);
</script>
</body>
</html>



